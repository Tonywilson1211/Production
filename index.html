<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photography Diary Manager (PoC v0.9.2.2)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for active tab */
        .tab.active {
            border-top: 4px solid #93be1e; /* Custom Green */
            background-color: #f9fafb; /* gray-50 */
            color: #93be1e; /* Custom Green */
        }
        .tab {
            border-top: 4px solid transparent;
        }
        /* Hide scrollbars for number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Style for disabled inputs */
        input:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
            color: #9ca3af; /* gray-400 */
        }

        /* Define custom green colors for Tailwind's JIT mode */
        .bg-custom-green { background-color: #93be1e; }
        .hover\:bg-custom-green-dark:hover { background-color: #7aa518; } /* Slightly darker for hover */
        .focus\:ring-custom-green:focus { --tw-ring-color: #93be1e; }
        .text-custom-green { color: #93be1e; }
        .border-custom-green { border-color: #93be1e; }
        .text-custom-green { color: #93be1e; }
        .focus\:border-custom-green:focus { border-color: #93be1e; }
        .focus\:ring-custom-green:focus { box-shadow: 0 0 0 2px #93be1e; }
        .text-custom-green { color: #93be1e; }
        .focus\:ring-custom-green:focus { --tw-ring-color: #93be1e; }
        
        /* Custom color for the finish window */
        .text-custom-finish { color: #c4d787; }

        /* Style for the '+' button when disabled */
        #add-new-diary-tab-button:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        #add-new-diary-tab-button:disabled:hover {
            background-color: #9ca3af; /* gray-400 */
        }

    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">

    <header class="bg-white shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center">
            <a href="https://wms.nichecom.co.uk/" target="_blank" class="flex items-center focus:outline-none">
                <img src="images/niche_logo_white.png" alt="NicheCom Logo" class="h-10 rounded-md hover:opacity-90 transition-opacity">
            </a>
            <h1 class="text-xl font-semibold text-gray-800 ml-4">Diary Booking Assistant (mock v.9.2.2)</h1>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 overflow-auto">
        
        <div id="page-staff-hub" class="sheet-content bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Team & Staff Hub</h1>
            
            <div class="mb-6">
                <label for="team-select" class="block text-sm font-medium text-gray-700">Select Team (Area)</label>
                <select id="team-select" class="mt-1 block w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                    <option selected>Orbital - Area 2</option>
                    <option disabled>Area 2 - South East (v1.0 Feature)</option>
                    <option disabled>Area 3 - Midlands (v1.0 Feature)</option>
                </select>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Staff List: Orbital - Area 2</h2>
                <button class="px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark" disabled>Add New Staff (Full v1.0 Feature)</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Category</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">James Wilson</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option selected>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Paul Udgaranya</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">William Howe</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Kacper Chodyra</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Raul Caramizaru</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option>Cat 3</option>
                                    <option selected>Custom Cat - Raul</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Ivan Pecek</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Jack Wickes</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">James Denton</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Jemma Ridyard</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Kyle Plastock</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Lloyd Woodger</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Rainer Knappe</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Tom McPherson</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="mt-4 text-sm text-gray-500 italic">This is a mock-up of the v1.0 "Staff Hub." In the full version, managers can add/remove staff and assign custom categories.</p>
        </div>


        <div id="page-key" class="sheet-content hidden bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Timing Assumptions Key</h1>
            <p class="text-sm text-gray-600 mb-6">This shows the rules for the "Standard" categories. The v1.0 app will allow managers to create custom categories.</p>
            <div id="key-categories-container" class="space-y-10">
                </div>
        </div>

        <div id="page-calculator" class="sheet-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Duration Calculator</h2>
                        <button type="button" id="tips-btn-calc" class="text-sm text-custom-green hover:text-green-700 font-medium flex items-center focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" /></svg>
                            Tips
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">A quick-lookup tool to estimate on-site time for a job.</p>
                    
                    <form id="calculator-form" class="space-y-4">
                        <div>
                            <label for="context-select" class="block text-sm font-medium text-gray-700">Select Context</label>
                            <select id="context-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                                </select>
                        </div>
                        <div id="raul-advisory-calc" class="hidden mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400 text-xs text-yellow-700">
                            <p class="font-bold">⚠️ Note:</p>
                            <p>Please check any sales orders from <strong>Locksbottom branches</strong> with Raul directly for timing.</p>
                        </div>
                        
                        <div>
                            <label for="calc-bedrooms" class="block text-sm font-medium text-gray-700">Property Size (Bedrooms)</label>
                            <input type="number" id="calc-bedrooms" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="Enter number of bedrooms...">
                        </div>

                        <div id="calc-floors-wrapper" class="floors-input-wrapper hidden">
                            <label for="calc-num-floors" class="block text-sm font-medium text-gray-700">Number of Floors (for 3D)</label>
                            <input type="number" id="calc-num-floors" name="num-floors" min="1" value="1" class="num-floors-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Products</label>
                            <div class="mt-2 space-y-2 h-48 overflow-y-auto border p-2 rounded-md" id="calc-products-list">
                                </div>
                        </div>

                        <div class="pt-4 flex space-x-2">
                            <button type="submit" class="w-2/3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                Calculate Duration
                            </button>
                            <button type="button" id="reset-calculator-button" class="w-1/3 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                Reset
                            </button>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Calculation Results</h2>
                    <div id="duration-results-wrapper" class="hidden space-y-6">
                        
                        <div class="text-center bg-custom-green text-white p-6 rounded-lg shadow">
                            <label class="block text-sm font-medium uppercase tracking-wider">Total On-Site Time (for <span id="selected-context-name">Cat 2</span>)</label>
                            <p id="total-time-display" class="text-5xl font-bold">1h 20m</p>
                            <p id="total-time-minutes" class="text-lg">(80 minutes)</p>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Category Comparison</h3>
                            <div id="category-comparison-display" class="space-y-2">
                                </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Calculation Breakdown (<span id="breakdown-context-name">Cat 2</span>)</h3>
                            <div id="calculation-breakdown-display" class="text-sm space-y-2 p-4 bg-gray-50 rounded-md border">
                                </div>
                        </div>
                    </div>
                    <p id="duration-placeholder" class="text-gray-500">Please select your inputs and click "Calculate" to see the results.</p>
                </div>
            </div>
        </div>

        <div id="page-diary" class="sheet-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">New Appointment</h2>
                    
                    <div class="mb-4">
                        <label for="photographer-select" class="block text-sm font-medium text-gray-700">1. Select Photographer</label>
                        <select id="photographer-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            <option value="" disabled selected>Select a photographer...</option>
                            </select>
                        <p id="photographer-category-display" class="mt-1 text-sm text-custom-green font-medium"></p>
                        <div id="raul-advisory-diary" class="hidden mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400 text-xs text-yellow-700">
                            <p class="font-bold">⚠️ Note:</p>
                            <p>Please check any sales orders from <strong>Locksbottom branches</strong> with Raul directly for timing.</p>
                        </div>
                        <p id="raul-note" class="mt-1 text-sm text-red-600 font-bold hidden">Note: Check Locksbottom sales orders with Raul.</p>
                    </div>

                    <form id="appointment-form" class="space-y-4">
                        <div class="opacity-50" id="form-fields-wrapper">
                            <div class="p-4 bg-gray-50 rounded-md border mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Optional (v1.0 Reference)</p>
                                <div class="space-y-2">
                                    <input type="text" id="ref-order-id" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="Order Reference">
                                    <input type="text" id="ref-address" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="First Line of Address">
                                    <input type="text" id="ref-postcode" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="Postcode">
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="first-job-arrival-time" class="block text-sm font-medium text-gray-700">First Job Arrival (8am-5pm)</label>
                                    <button type="button" onclick="showTipsModal()" class="text-sm text-custom-green font-medium hover:underline focus:outline-none">Tips</button>
                                </div>
                                <input type="time" id="first-job-arrival-time" value="09:00" min="08:00" max="17:00" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            </div>
                            
                            <div>
                                <label for="travel-time" class="block text-sm font-medium text-gray-700">Travel Time (mins)</label>
                                <input type="number" id="travel-time" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 30">
                            </div>

                            <div>
                                <label for="bedrooms" class="block text-sm font-medium text-gray-700">Property Size (Bedrooms)</label>
                                <input type="number" id="bedrooms" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 3">
                            </div>

                            <div class="floors-input-wrapper hidden">
                                <label for="num-floors" class="block text-sm font-medium text-gray-700">Number of Floors (for 3D)</label>
                                <input type="number" name="num-floors" min="1" value="1" class="num-floors-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Products</label>
                                <div class="mt-2 space-y-2 h-32 overflow-y-auto border p-2 rounded-md" id="products-list">
                                    </div>
                            </div>

                            <div class="space-y-2 pt-2">
                                <label for="additional-time" class="block text-sm font-medium text-gray-700">Additional Time (Optional)</label>
                                <input type="number" id="additional-time" name="additional-time" class="additional-time-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 15 mins">

                                <div class="flex items-center pt-2">
                                    <input id="ad-hoc-job" name="ad-hoc-job" type="checkbox" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green" disabled>
                                    <label for="ad-hoc-job" class="ml-2 block text-sm text-gray-700">Ad-Hoc Job (Full v1.0 Feature)</label>
                                </div>
                            </div>

                            <div class="flex justify-between pt-4 space-x-2">
                                <button type="submit" class="w-1/2 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                    Add Appointment
                                </button>
                                <button type="button" id="delete-last-job" class="w-1/4 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                    Delete Last
                                </button>
                                <button type="button" id="redo-mock" class="w-1/4 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed" title="Full 'Redo' feature available in v1.0" disabled>
                                    Redo
                                </button>
                                <button type="button" id="reset-schedule" class="w-1/4 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 id="schedule-title" class="text-xl font-bold text-gray-800 mb-6">Calculated Schedule</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job #</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Ref</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postcode</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Travel</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buffer</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrival (Window)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WMS</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beds</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration (h:mm)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finish (Window)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="schedule-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav id="tab-navigation" class="flex border-t border-gray-300 bg-white shadow-inner">
        </nav>

    <div id="tips-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold text-gray-900">Property Sizing Tips</h3>
            <div class="mt-4 space-y-2 text-sm text-gray-700">
                <ul class="list-disc list-inside space-y-2">
                    <li>Ask the contact for a rough square footage and if there are any outbuildings.</li>
                    <li>Check if the number of bathrooms is similar to the number of bedrooms (a good indicator of a large property).</li>
                    <li>Search the postcode in WMS to see if we have visited before.</li>
                    <li>4. Use Rightmove sold prices to see if there are previous images/floorplans. <a href="https://www.rightmove.co.uk/house-prices.html" target="_blank" rel="noopener noreferrer" class="text-custom-green hover:underline font-medium">Open Rightmove</a></li>
                    <li>5. Check to see if there is an EPC on the property. <a href="https://www.gov.uk/find-energy-certificate" target="_blank" rel="noopener noreferrer" class="text-custom-green hover:underline font-medium">Find Energy Certificate</a></li>
                    <li>Use Google Street View to get a visual sense of the property.</li>
                    <li>Place full property address into google search. This may reveal previous listing links or images.</li>
                    <li class="font-bold">Area 2 Average is ~1300sqft. Anything over 2500sqft may require extra time.</li>
                </ul>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="closeTipsModal()" class="px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & ASSUMPTIONS ---

        // 30-minute arrival window buffer
        const ARRIVAL_WINDOW_BUFFER = 30;
        // NEW: Max number of diary tabs
        const MAX_DIARY_PAGES = 4;

        const timingCategories = {
            cat1: {
                name: "Cat 1 (New Staff)",
                travelBuffer: 10,
                floorSurcharge: 10, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'premium_photos': [ { maxBeds: 2, time: 60 }, { maxBeds: 4, time: 70 }, { maxBeds: 6, time: 80 }, { maxBeds: Infinity, time: 90 } ],
                    'floorplan': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'epc': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'video': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 35 }, { maxBeds: Infinity, time: 35 } ],
                    'drone_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 40 } ],
                    'drone_video': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 35 }, { maxBeds: 6, time: 45 }, { maxBeds: Infinity, time: 45 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'elevated_single': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 20 }, { maxBeds: Infinity, time: 20 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'video_presented': [ { maxBeds: 2, time: 55 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 65 } ]
                }
            },
            cat2: {
                name: "Cat 2 (Mid-Range)",
                travelBuffer: 10,
                floorSurcharge: 5, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'premium_photos': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'floorplan': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'epc': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'video': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'drone_photos': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'drone_video': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 35 }, { maxBeds: Infinity, time: 35 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'elevated_single': [ { maxBeds: 2, time: 15 }, { maxBeds: 4, time: 15 }, { maxBeds: 6, time: 15 }, { maxBeds: Infinity, time: 15 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'video_presented': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 45 }, { maxBeds: 6, time: 55 }, { maxBeds: Infinity, time: 55 } ]
                }
            },
            cat3: {
                name: "Cat 3 (Experienced)",
                travelBuffer: 10,
                floorSurcharge: 5, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 50 } ],
                    'premium_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'floorplan': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 50 } ],
                    'epc': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 50 } ],
                    'video': [ { maxBeds: 2, time: 15 }, { maxBeds: 4, time: 15 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'drone_photos': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'drone_video': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 45 }, { maxBeds: 6, time: 55 }, { maxBeds: Infinity, time: 65 } ],
                    'elevated_single': [ { maxBeds: 2, time: 10 }, { maxBeds: 4, time: 10 }, { maxBeds: 6, time: 10 }, { maxBeds: Infinity, time: 10 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 20 }, { maxBeds: Infinity, time: 20 } ],
                    'video_presented': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 35 }, { maxBeds: 6, time: 45 }, { maxBeds: Infinity, time: 45 } ]
                }
            },
            cat_raul: {
                name: "Custom Cat - Raul Caramizaru",
                travelBuffer: 10,
                floorSurcharge: 5, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [{ maxBeds: 1, time: 20 }, { maxBeds: 2, time: 25 }, { maxBeds: 3, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 5, time: 45 }, { maxBeds: Infinity, time: 0 }],
                    'premium_photos': [{ maxBeds: 1, time: 30 }, { maxBeds: 2, time: 35 }, { maxBeds: 3, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 5, time: 60 }, { maxBeds: Infinity, time: 0 }],
                    'capture_photos': [{ maxBeds: 1, time: 30 }, { maxBeds: 2, time: 40 }, { maxBeds: 3, time: 50 }, { maxBeds: 4, time: 60 }, { maxBeds: 5, time: 70 }, { maxBeds: Infinity, time: 0 }],
                    'floorplan': [{ maxBeds: 1, time: 20 }, { maxBeds: 2, time: 25 }, { maxBeds: 3, time: 30 }, { maxBeds: 4, time: 45 }, { maxBeds: 5, time: 60 }, { maxBeds: Infinity, time: 0 }],
                    'epc': [{ maxBeds: 1, time: 20 }, { maxBeds: 2, time: 25 }, { maxBeds: 3, time: 30 }, { maxBeds: 4, time: 35 }, { maxBeds: 5, time: 40 }, { maxBeds: Infinity, time: 0 }],
                    'video': [{ maxBeds: 1, time: 15 }, { maxBeds: 2, time: 15 }, { maxBeds: 3, time: 15 }, { maxBeds: 4, time: 20 }, { maxBeds: 5, time: 20 }, { maxBeds: Infinity, time: 0 }],
                    'drone_photos': [{ maxBeds: 1, time: 20 }, { maxBeds: 2, time: 20 }, { maxBeds: 3, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 5, time: 30 }, { maxBeds: Infinity, time: 0 }],
                    'drone_video': [{ maxBeds: 1, time: 25 }, { maxBeds: 2, time: 25 }, { maxBeds: 3, time: 25 }, { maxBeds: 4, time: 30 }, { maxBeds: 5, time: 30 }, { maxBeds: Infinity, time: 0 }],
                    'showcase_3d': [{ maxBeds: 1, time: 30 }, { maxBeds: 2, time: 35 }, { maxBeds: 3, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 5, time: 60 }, { maxBeds: Infinity, time: 0 }],
                    'elevated_single': [{ maxBeds: 1, time: 10 }, { maxBeds: 2, time: 10 }, { maxBeds: 3, time: 10 }, { maxBeds: 4, time: 10 }, { maxBeds: 5, time: 10 }, { maxBeds: Infinity, time: 0 }],
                    'elevated_multi': [{ maxBeds: 1, time: 20 }, { maxBeds: 2, time: 20 }, { maxBeds: 3, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 5, time: 20 }, { maxBeds: Infinity, time: 0 }],
                    'video_presented': [{ maxBeds: 1, time: 35 }, { maxBeds: 2, time: 35 }, { maxBeds: 3, time: 35 }, { maxBeds: 4, time: 45 }, { maxBeds: 5, time: 45 }, { maxBeds: Infinity, time: 0 }]
                }
            }
        };

        // Hard-coded photographer list
        let photographerProfiles = {
            p1: { name: "James Wilson", category: 'cat1' },
            p2: { name: "Paul Udgaranya", category: 'cat2' },
            p3: { name: "William Howe", category: 'cat3' },
            p4: { name: "Kacper Chodyra", category: 'cat2' },
            p5: { name: "Raul Caramizaru", category: 'cat_raul' },
            p6: { name: "Ivan Pecek", category: 'cat2' },
            p7: { name: "Jack Wickes", category: 'cat3' },
            p8: { name: "James Denton", category: 'cat2' },
            p9: { name: "Jemma Ridyard", category: 'cat3' },
            p10: { name: "Kyle Plastock", category: 'cat3' },
            p11: { name: "Lloyd Woodger", category: 'cat3' },
            p12: { name: "Rainer Knappe", category: 'cat2' },
            p13: { name: "Tom McPherson", category: 'cat3' },
        };
        
        // List of all products offered
        const productList = [
            { id: 'standard_photos', name: 'Standard Photography' },
            { id: 'premium_photos', name: 'Premium Photography' },
            { id: 'capture_photos', name: 'Capture Photography' },
            { id: 'floorplan', name: 'Floorplan' },
            { id: 'epc', name: 'EPC' },
            { id: 'video', name: 'Property Video' },
            { id: 'drone_photos', name: 'Drone Photography' },
            { id: 'drone_video', name: 'Drone Video' },
            { id: 'showcase_3d', name: '3D Showcase' },
            { id:'elevated_single', name: 'Elevated (Single)' },
            { id:'elevated_multi', name: 'Elevated (Multi)' },
            { id: 'video_presented', name: 'Property Video (Presented)' }
        ];

        // --- GLOBAL STATE ---
        
        // BUG B (Ignored): This data state is shared by all tabs for the same photographer.
        // This is OK for the mock-up, per user request.
        let appointments = {};
        
        let diaryPages = []; // NEW: Array to hold diary page states
        let currentPageId = null; // NEW: To track the active page

        // --- CORE FUNCTIONS ---

        /**
         * Initialize the application
         */
        function init() {
            // Initialize appointment array for each photographer
            for (const photoId in photographerProfiles) {
                if (photographerProfiles.hasOwnProperty(photoId)) {
                    appointments[photoId] = [];
                }
            }

            // --- SIMPLIFIED INIT ---
            // addNewDiaryPage creates the first page, populates it, and adds listeners
            addNewDiaryPage(); 
            
            populateKeySheet();
            
            // Setup for new Duration Calculator page
            populateContextDropdown();
            populateCalcProductsList();
            toggleCalcFloorInput(document.getElementById('page-calculator')); // Initial check
            document.getElementById('calculator-form').addEventListener('submit', handleCalculateDuration);
            document.getElementById('reset-calculator-button').addEventListener('click', resetCalculator);
            document.getElementById('tips-btn-calc').addEventListener('click', showTipsModal);
            document.getElementById('context-select').addEventListener('change', (e) => {
                const text = e.target.options[e.target.selectedIndex].text;
                const advisory = document.getElementById('raul-advisory-calc');
                if (text.includes("Raul")) {
                    advisory.classList.remove('hidden');
                } else {
                    advisory.classList.add('hidden');
                }
            });

            // Show the 'Staff Hub' sheet by default
            // addNewDiaryPage switches to the new page, so we switch back.
            switchSheet('page-staff-hub');
        }

        /**
         * NEW: Resets the calculator form and results
         */
        function resetCalculator() {
            const pageElement = document.getElementById('page-calculator');
            
            // Reset form fields
            pageElement.querySelector('#context-select').value = '';
            pageElement.querySelector('#calc-bedrooms').value = '';
            pageElement.querySelector('#calc-num-floors').value = '1';
            
            // Uncheck all products and re-enable them
            const productCheckboxes = pageElement.querySelectorAll('.calc-product-checkbox');
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
            });
            
            // Hide floors input
            toggleCalcFloorInput(pageElement);

            // Hide results and show placeholder
            pageElement.querySelector('#duration-results-wrapper').classList.add('hidden');
            pageElement.querySelector('#duration-placeholder').classList.remove('hidden');
        }

        /**
         * NEW: Adds a new diary page, up to the max limit
         */
        function addNewDiaryPage() {
            // NEW: Check if we have reached the max number of diary pages
            if (diaryPages.length >= MAX_DIARY_PAGES) {
                showModal("Maximum number of diaries open");
                return;
            }

            const newPageId = `page-diary-${diaryPages.length}`;
            const newPage = {
                id: newPageId,
                photographerId: null,
                name: "Diary Booking" // NEW: Default name
            };
            diaryPages.push(newPage);

            const mainContent = document.querySelector('main');
            // Clone the TEMPLATE page (which is always hidden)
            const diaryPageClone = document.getElementById('page-diary').cloneNode(true);
            diaryPageClone.id = newPageId;
            // The template is hidden, but the clone should not be (switchSheet will hide it again)
            diaryPageClone.classList.remove('hidden'); 

            // Add a close button if this is not the first diary page
            if (diaryPages.length > 1) {
                const closeButton = document.createElement('button');
                closeButton.className = "absolute top-4 right-4 p-2 text-gray-400 hover:text-red-600";
                closeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                closeButton.onclick = (e) => { // Use onclick for simplicity on a clone
                    e.stopPropagation();
                    closeDiaryPage(newPageId);
                };
                
                const scheduleTitle = diaryPageClone.querySelector('#schedule-title');
                scheduleTitle.parentNode.style.position = 'relative';
                scheduleTitle.parentNode.appendChild(closeButton);
            }

            mainContent.appendChild(diaryPageClone);

            // Setup the new page
            populateProductsList(diaryPageClone);
            const newPhotographerSelect = diaryPageClone.querySelector('#photographer-select');
            populatePhotographerDropdown(newPhotographerSelect);
            
            // Add listeners to the new page
            newPhotographerSelect.addEventListener('change', selectPhotographer);
            diaryPageClone.querySelector('#appointment-form').addEventListener('submit', handleAddAppointment);
            diaryPageClone.querySelector('#reset-schedule').addEventListener('click', resetSchedule);
            diaryPageClone.querySelector('#delete-last-job').addEventListener('click', handleDeleteLastJob);
            
            toggleFloorInput(diaryPageClone); // Ensure floors input is hidden on new page

            // Update UI
            currentPageId = newPageId;
            populateMainTabs(); // This will now draw all tabs and update the '+' button
            switchSheet(newPageId);
        }

        /**
         * NEW: Closes a diary page
         */
        function closeDiaryPage(pageId) {
            // Only allow closing if there's more than one diary page
            if (diaryPages.length <= 1) {
                showModal("You cannot close the last diary page.");
                return;
            }

            showModal("Are you sure you want to close this diary tab?", () => {
                const pageIndex = diaryPages.findIndex(p => p.id === pageId);
                if (pageIndex > -1) {
                    
                    // Remove page from state
                    const closedPage = diaryPages.splice(pageIndex, 1)[0];
                    
                    // Clear its data (optional, but good practice)
                    if (closedPage.photographerId) {
                        appointments[closedPage.photographerId] = [];
                    }

                    // Remove page from DOM
                    const pageElement = document.getElementById(pageId);
                    if (pageElement) {
                        pageElement.remove();
                    }
                    
                    // Update UI
                    populateMainTabs(); // Redraw tabs and update '+' button

                    // Switch to a different page if the active one was closed
                    if (currentPageId === pageId) {
                        // Switch to the first diary page or staff hub
                        const newPageToSelect = diaryPages.length > 0 ? diaryPages[0].id : 'page-staff-hub';
                        switchSheet(newPageToSelect);
                    } else {
                        // Just update the active tab visual
                        updateActiveTab();
                    }
                }
            });
        }
        
        /**
         * REWRITTEN (Fix for Bug A): Create tabs dynamically
         */
        function populateMainTabs() {
            const nav = document.getElementById('tab-navigation');
            nav.innerHTML = ''; // Clear existing tabs

            const staticPages = [
                { id: 'page-staff-hub', name: 'Staff Hub', icon: 'users' },
                { id: 'page-key', name: 'Key', icon: 'key' },
                { id: 'page-calculator', name: 'Duration Calculator', icon: 'calculator' },
            ];

            const icons = {
                'users': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372m.375-3.72a9.375 9.375 0 0 0-3.75 0m5.625 3.72a9.375 9.375 0 0 1-3.75 0M3.375 19.128a9.375 9.375 0 0 1 3.75 0m5.625 3.72a9.375 9.375 0 0 0-3.75 0m3.75-3.72a9.375 9.375 0 0 0 3.75 0m-9.375 3.72a9.375 9.375 0 0 1-3.75 0M14.625 12a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm-3.375 0a.375.375 0 0 0-.375.375v.375c0 .207.168.375.375.375h.375a.375.375 0 0 0 .375-.375v-.375a.375.375 0 0 0-.375-.375h-.375Z" /></svg>',
                'key': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" /></svg>',
                'calculator': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25v-.008Zm2.25-4.5h.008v.008H10.5v-.008Zm0 2.25h.008v.008H10.5v-.008Zm0 2.25h.008v.008H10.5v-.008Zm2.25-4.5h.008v.008H12.75v-.008Zm0 2.25h.008v.008H12.75v-.008Zm0 2.25h.008v.008H12.75v-.008Zm2.25-4.5h.008v.008H15v-.008Zm0 2.25h.008v.008H15v-.008Zm0 2.25h.008v.008H15v-.008Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h18M3 21h18v-3H3v3Zm0-3h18V6H3v12Z" /></svg>',
                'calendar-days': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>'
            };

            // 1. Add static tabs
            staticPages.forEach(page => {
                const tab = document.createElement('button');
                tab.dataset.sheet = page.id;
                tab.className = 'tab flex-1 p-4 text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-custom-green focus:outline-none flex items-center justify-center';
                tab.innerHTML = `${icons[page.icon]} ${page.name}`;
                tab.addEventListener('click', () => switchSheet(page.id));
                nav.appendChild(tab);
            });

            // 2. Add dynamic diary tabs
            diaryPages.forEach(page => {
                const tab = document.createElement('button');
                tab.dataset.sheet = page.id;
                tab.className = 'tab flex-1 p-4 text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-custom-green focus:outline-none flex items-center justify-center truncate';
                // NEW: Use the dynamic name and icon
                tab.innerHTML = `${icons['calendar-days']} ${page.name}`;
                tab.addEventListener('click', () => switchSheet(page.id));
                nav.appendChild(tab);
            });

            // 3. Add the '+' button
            const addTab = document.createElement('button');
            addTab.id = 'add-new-diary-tab-button'; // NEW: Give it an ID
            addTab.className = 'p-4 text-sm font-medium text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none flex items-center justify-center';
            addTab.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>';
            addTab.addEventListener('click', addNewDiaryPage);
            nav.appendChild(addTab);

            // 4. Update tab states
            updateActiveTab();
            updateAddTabButtonState();
        }

        /**
         * NEW: Updates the active tab visual
         */
        function updateActiveTab() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.sheet === currentPageId) {
                    tab.classList.add('active');
                }
            });
        }

        /**
         * NEW: Checks diary page count and disables the '+' button
         */
        function updateAddTabButtonState() {
            const addTabButton = document.getElementById('add-new-diary-tab-button');
            if (!addTabButton) return;

            if (diaryPages.length >= MAX_DIARY_PAGES) {
                addTabButton.disabled = true;
            } else {
                addTabButton.disabled = false;
            }
        }

        /**
         * Switch between the 'sheets'
         */
        function switchSheet(sheetId) {
            currentPageId = sheetId;
            // Hide all sheets
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.add('hidden');
            });
            // Show the selected one
            const pageElement = document.getElementById(sheetId);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }

            // Update tab active state
            updateActiveTab();

            // Disable form if no photographer is selected on a diary page
            const page = diaryPages.find(p => p.id === sheetId);
            if (page) {
                disableCalculatorForm(pageElement, !page.photographerId);
            }
        }

        /**
         * Populate the photographer dropdown on the Diary page
         */
        function populatePhotographerDropdown(selectElement) {
            selectElement.innerHTML = '<option value="" disabled selected>Select a photographer...</option>';
            for (const photoId in photographerProfiles) {
                const profile = photographerProfiles[photoId];
                const option = document.createElement('option');
                option.value = photoId;
                option.textContent = profile.name;
                selectElement.appendChild(option); // Changed from innerHTML
            }
        }
        
        /**
         * NEW: Populates the dropdown on the Duration Calculator page
         */
        function populateContextDropdown() {
            const select = document.getElementById('context-select');
            select.innerHTML = ''; // Clear options

            select.innerHTML += `<option value="" disabled selected>Select a context...</option>`;
            
            const catGroup = document.createElement('optgroup');
            catGroup.label = "Generic Categories";
            for (const catId in timingCategories) {
                const category = timingCategories[catId];
                const option = document.createElement('option');
                option.value = catId; // e.g., "cat1"
                option.textContent = category.name;
                catGroup.appendChild(option);
            }
            select.appendChild(catGroup);

            const photogGroup = document.createElement('optgroup');
            photogGroup.label = "Photographers";
            for (const photoId in photographerProfiles) {
                const profile = photographerProfiles[photoId];
                const category = timingCategories[profile.category];
                const option = document.createElement('option');
                option.value = profile.category; // e.g., "cat1"
                option.textContent = `${profile.name} (${category.name})`;
                photogGroup.appendChild(option);
            }
            select.appendChild(photogGroup);
        }
        
        /**
         * Populate the 'Key' sheet with tables for *all* categories
         */
        function populateKeySheet() {
            const container = document.getElementById('key-categories-container');
            container.innerHTML = ''; 
            
            for (const catId in timingCategories) {
                const category = timingCategories[catId];
                
                // Create main container
                const categoryBlock = document.createElement('div');
                categoryBlock.className = 'border border-gray-200 rounded-lg bg-white overflow-hidden mb-4 shadow-sm';
                
                // Create Header (Clickable)
                const header = document.createElement('button');
                header.className = 'w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-left focus:outline-none';
                header.innerHTML = `
                    <h2 class="text-lg font-bold text-custom-green">${category.name}</h2>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 transform transition-transform duration-200 chevron-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                `;
                
                // Create Content (Hidden by default)
                const content = document.createElement('div');
                content.className = 'hidden p-6 border-t border-gray-200';
                
                // Toggle Logic
                header.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    const icon = header.querySelector('.chevron-icon');
                    if (content.classList.contains('hidden')) {
                        icon.classList.remove('rotate-180');
                    } else {
                        icon.classList.add('rotate-180');
                    }
                });

                // --- Build The Table Content (Same logic as before) ---
                let html = `
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">General Rules</h3>
                        <p class="text-sm text-gray-700">Travel Buffer: <span class="font-medium">${category.travelBuffer} mins</span></p>
                        <p class="text-sm text-gray-700">3D Floor Surcharge: <span class="font-medium">+${category.floorSurcharge} mins/floor</span></p>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Product Timings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                `;
                
                // Helper for product name
                const getProductName = (id) => productList.find(p => p.id === id)?.name || id;

                // Loop products
                const products = category.products || {}; 
                // Note: In new structure, 'products' is an object, not array. 
                // Use productList to define order.
                productList.forEach(p => {
                    if(products[p.id]) {
                         const rules = products[p.id];
                         html += `<div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <h4 class="font-semibold text-gray-800 text-sm mb-2">${p.name}</h4>
                                    <ul class="text-xs space-y-1 text-gray-600">`;
                         
                         let lastBeds = 0;
                         rules.forEach(r => {
                             let label = r.maxBeds === Infinity ? `${lastBeds + 1}+` : `${lastBeds+1}-${r.maxBeds}`;
                             if (lastBeds === 0 && r.maxBeds !== Infinity) label = `1-${r.maxBeds}`; // Fix for 1-2
                             if (category.name.includes("Raul")) { 
                                 // Raul specific single digit display preference if needed, 
                                 // or just use standard ranges. 
                                 // Keeping standard logic for simplicity unless 1-1 mapping is strict.
                                 if(r.maxBeds !== Infinity && r.maxBeds === lastBeds + 1) label = `${r.maxBeds}`; // Single bed logic
                             }
                             
                             html += `<li class="flex justify-between"><span>${label} bds:</span> <span>${r.time}m</span></li>`;
                             lastBeds = r.maxBeds;
                         });
                         html += `</ul></div>`;
                    }
                });

                html += `</div>`; // Close grid
                
                // Add 7+ Bed Note if Cat 1
                if (catId === 'cat1') {
                    html += `<p class="text-xs text-gray-400 italic mt-4 pt-4 border-t">* For 7+ bed properties, please contact the photographer.</p>`;
                }

                content.innerHTML = html;
                categoryBlock.appendChild(header);
                categoryBlock.appendChild(content);
                container.appendChild(categoryBlock);
            }
        }
        
        /**
         * Populate the checkboxes for products on the form
         */
        function populateProductsList(pageElement) {
            const listDiv = pageElement.querySelector('#products-list');
            const pageId = pageElement.id;
            listDiv.innerHTML = '';
            
            productList.forEach(product => {
                const productId = `${product.id}-${pageId}`; // Unique ID for the checkbox
                const item = `
                    <div class="flex items-center">
                        <input id="${productId}" name="product" type="checkbox" value="${product.id}" data-product-id="${product.id}" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green product-checkbox">
                        <label for="${productId}" class="ml-3 block text-sm text-gray-700">${product.name}</label>
                    </div>
                `;
                listDiv.innerHTML += item;
            });

            // --- MUTUAL EXCLUSION LOGIC (Standard vs. Premium vs. Capture) ---
            const standardPhotosCheckbox = pageElement.querySelector(`input[data-product-id="standard_photos"]`);
            const premiumPhotosCheckbox = pageElement.querySelector(`input[data-product-id="premium_photos"]`);
            const capturePhotosCheckbox = pageElement.querySelector(`input[data-product-id="capture_photos"]`);

            const photoCheckboxes = [standardPhotosCheckbox, premiumPhotosCheckbox, capturePhotosCheckbox];

            photoCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        photoCheckboxes.forEach(otherCheckbox => {
                            if (otherCheckbox !== checkbox) {
                                otherCheckbox.disabled = true;
                                otherCheckbox.checked = false;
                            }
                        });
                    } else {
                        photoCheckboxes.forEach(otherCheckbox => {
                            otherCheckbox.disabled = false;
                        });
                    }
                });
            });

            // --- NEW: 3D SHOWCASE FLOOR INPUT LOGIC ---
            pageElement.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => toggleFloorInput(pageElement));
            });
        }

        /**
         * NEW: Populates the product list on the Duration Calculator page
         */
        function populateCalcProductsList() {
            const pageElement = document.getElementById('page-calculator');
            const listDiv = pageElement.querySelector('#calc-products-list');
            const pageId = 'calculator-page'; // Unique static ID
            listDiv.innerHTML = '';
            
            productList.forEach(product => {
                const productId = `${product.id}-${pageId}`; // Unique ID for the checkbox
                const item = `
                    <div class="flex items-center">
                        <input id="${productId}" name="calc-product" type="checkbox" value="${product.id}" data-product-id="${product.id}" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green calc-product-checkbox">
                        <label for="${productId}" class="ml-3 block text-sm text-gray-700">${product.name}</label>
                    </div>
                `;
                listDiv.innerHTML += item;
            });

            // --- MUTUAL EXCLUSION LOGIC ---
            const standardPhotosCheckbox = pageElement.querySelector(`input[data-product-id="standard_photos"]`);
            const premiumPhotosCheckbox = pageElement.querySelector(`input[data-product-id="premium_photos"]`);
            const capturePhotosCheckbox = pageElement.querySelector(`input[data-product-id="capture_photos"]`);

            const photoCheckboxes = [standardPhotosCheckbox, premiumPhotosCheckbox, capturePhotosCheckbox];

            photoCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        photoCheckboxes.forEach(otherCheckbox => {
                            if (otherCheckbox !== checkbox) {
                                otherCheckbox.disabled = true;
                                otherCheckbox.checked = false;
                            }
                        });
                    } else {
                        photoCheckboxes.forEach(otherCheckbox => {
                            otherCheckbox.disabled = false;
                        });
                    }
                });
            });

            // --- 3D SHOWCASE FLOOR INPUT LOGIC ---
            pageElement.querySelectorAll('.calc-product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => toggleCalcFloorInput(pageElement));
            });
        }

        /**
         * NEW: Show/Hide the "Number of Floors" input based on 3D Showcase
         */
        function toggleFloorInput(pageElement) {
            const showcaseCheckbox = pageElement.querySelector(`input[data-product-id="showcase_3d"]`);
            const floorsWrapper = pageElement.querySelector('.floors-input-wrapper');
            
            if (showcaseCheckbox && showcaseCheckbox.checked) {
                floorsWrapper.classList.remove('hidden');
            } else {
                floorsWrapper.classList.add('hidden');
                pageElement.querySelector('.num-floors-input').value = 1; // Reset to 1 when hidden
            }
        }

        /**
         * NEW: Show/Hide the "Number of Floors" input on the Calculator page
         */
        function toggleCalcFloorInput(pageElement) {
            const showcaseCheckbox = pageElement.querySelector(`input[data-product-id="showcase_3d"]`);
            const floorsWrapper = pageElement.querySelector('#calc-floors-wrapper');
            
            if (showcaseCheckbox && showcaseCheckbox.checked) {
                floorsWrapper.classList.remove('hidden');
            } else {
                floorsWrapper.classList.add('hidden');
                pageElement.querySelector('#calc-num-floors').value = 1; // Reset to 1 when hidden
            }
        }

        /**
         * MODIFIED: Handle selecting a photographer from the dropdown
         */
        function selectPhotographer(e) {
            const pageElement = e.target.closest('.sheet-content');
            const pageId = pageElement.id;
            const page = diaryPages.find(p => p.id === pageId);
            if (!page) return;

            // BUG B: This is where the shared data problem starts.
            // If another page is using this photographer, we're about to reset their schedule.
            // We are IGNORING this for the mock-up, as requested.
            page.photographerId = e.target.value;
            
            const raulNote = pageElement.querySelector('#raul-note');

            if (page.photographerId) {
                const profile = photographerProfiles[page.photographerId];
                page.name = profile.name; // NEW: Set the page name
                disableCalculatorForm(pageElement, false);
                pageElement.querySelector('#schedule-title').textContent = `Calculated Schedule: ${profile.name}`;
                pageElement.querySelector('#photographer-category-display').textContent = `Using Category: ${timingCategories[profile.category].name}`;

                // ... existing code ...
                const advisory = pageElement.querySelector('#raul-advisory-diary');
                if (profile.name.includes("Raul")) {
                    advisory.classList.remove('hidden');
                } else {
                    advisory.classList.add('hidden');
                }
                // ... existing code ...

                if (profile.name === "Raul Caramizaru") {
                    raulNote.classList.remove('hidden');
                } else {
                    raulNote.classList.add('hidden');
                }

            } else {
                page.name = "Diary Booking"; // NEW: Reset the page name
                disableCalculatorForm(pageElement, true);
                pageElement.querySelector('#schedule-title').textContent = `Calculated Schedule`;
                pageElement.querySelector('#photographer-category-display').textContent = ``;
                raulNote.classList.add('hidden');
            }
            
            populateMainTabs(); // NEW: Redraw tabs to show the new name
            renderSchedule(); // This will clear the schedule if appointments[] is empty
            resetFormFields(pageElement);
        }

        /**
         * Enable/disable the calculator form
         */
        function disableCalculatorForm(pageElement, disabled) {
            const wrapper = pageElement.querySelector('#form-fields-wrapper');
            if (disabled) {
                wrapper.classList.add('opacity-50', 'pointer-events-none');
            } else {
                wrapper.classList.remove('opacity-50', 'pointer-events-none');
            }
        }


        /**
         * Handle the form submission to add a new appointment
         */
        function handleAddAppointment(e) {
            e.preventDefault();
            
            const pageElement = e.target.closest('.sheet-content');
            const pageId = pageElement.id;
            const page = diaryPages.find(p => p.id === pageId);
            if (!page || !page.photographerId) {
                showModal("Please select a photographer first.");
                return;
            }
            
            // 1. Get all form values
            const photographer = photographerProfiles[page.photographerId];
            const bedrooms = parseInt(pageElement.querySelector('#bedrooms').value) || 0;
            const selectedProducts = [];
            pageElement.querySelectorAll('input[name="product"]:checked').forEach(checkbox => {
                selectedProducts.push({
                    id: checkbox.value,
                    name: checkbox.nextElementSibling.textContent,
                    type: checkbox.dataset.type
                });
            });

            // Raul's Advisories
            if (photographer.name === "Raul Caramizaru") {
                if (bedrooms >= 6) {
                    showModal("Advisory: For 6+ bedrooms, please check timings with Raul.");
                }
                if (selectedProducts.some(p => p.id === 'capture_photos')) {
                    showModal("Advisory: For Capture orders, please check timings with Raul.");
                }
            }

            if (bedrooms >= 7) {
                showModal("Advisory: You have selected a 7+ bedroom property. Please contact the photographer to confirm the estimated duration.");
            }
            const travelTime = parseInt(pageElement.querySelector('#travel-time').value) || 0;
            
            const orderRef = pageElement.querySelector('#ref-order-id').value;
            const address = pageElement.querySelector('#ref-address').value;
            const postcode = pageElement.querySelector('#ref-postcode').value;


            // 2. Validation
            if (selectedProducts.length === 0) {
                showModal("Please select at least one product.");
                return;
            }
            if (bedrooms <= 0) {
                showModal("Please enter a valid number of bedrooms.");
                return;
            }
            
            // 3. Get ruleset and calculate duration
            // BUG B (Ignored): We get the schedule for the photographer, not the page.
            const currentSchedule = appointments[page.photographerId]; 
            const categoryId = photographerProfiles[page.photographerId].category;
            const ruleset = timingCategories[categoryId];

            const numFloors = parseInt(pageElement.querySelector('.num-floors-input').value) || 1;
            const additionalTime = parseInt(pageElement.querySelector('.additional-time-input').value) || 0;
            const duration = calculateDuration(bedrooms, selectedProducts, ruleset, numFloors) + additionalTime;

            // 4. --- Core Calculation Engine ---
            
            let arrivalTimeMins, arrivalWindowEndMins, finishTimeMins, finishWindowEndMins, wmsTimeMins, buffer;
            let latestFinishTimeForNextJob = 0;
            
            if (currentSchedule.length === 0) {
                // This is the FIRST job of the day
                
                // --- FIX for Bug C ---
                // WAS: const arrivalTimeStr = document.getElementById('first-job-arrival-time').value;
                // IS: Get the time from the *current page element*
                const arrivalTimeStr = pageElement.querySelector('#first-job-arrival-time').value;
                // --- End of Fix ---

                arrivalTimeMins = timeStringToMinutes(arrivalTimeStr); // e.g., "09:00" -> 540
                
                buffer = 0;
                
                arrivalWindowEndMins = arrivalTimeMins + ARRIVAL_WINDOW_BUFFER; // 540 + 30 = 570
                finishTimeMins = arrivalTimeMins + duration;
                finishWindowEndMins = arrivalWindowEndMins + duration;

                wmsTimeMins = arrivalTimeMins;
                
                latestFinishTimeForNextJob = finishTimeMins;

            } else {
                // This is a SUBSEQUENT job
                latestFinishTimeForNextJob = currentSchedule[currentSchedule.length - 1].latestFinishMins;
                
                buffer = ruleset.travelBuffer;
                
                const trueArrivalMins = latestFinishTimeForNextJob + travelTime + buffer;
                
                arrivalTimeMins = roundToNearest(trueArrivalMins, 15);
                
                arrivalWindowEndMins = arrivalTimeMins + ARRIVAL_WINDOW_BUFFER;
                finishTimeMins = arrivalTimeMins + duration;
                finishWindowEndMins = arrivalWindowEndMins + duration;

                const midArrivalMins = arrivalTimeMins + (ARRIVAL_WINDOW_BUFFER / 2);
                wmsTimeMins = roundToNearest(midArrivalMins, 30);

                latestFinishTimeForNextJob = finishTimeMins;
            }

            // 5. Create appointment object
            const newAppointment = {
                orderRef: orderRef,
                address: address,
                postcode: postcode,
                travel: travelTime,
                buffer: buffer,
                arrivalStr: formatMinutes(arrivalTimeMins),
                arrivalWindowEndStr: formatMinutes(arrivalWindowEndMins),
                bedrooms: bedrooms,
                productsStr: selectedProducts.map(p => p.name).join(', '),
                duration: duration,
                finishTimeStr: formatMinutes(finishTimeMins),
                finishWindowEndStr: formatMinutes(finishWindowEndMins),
                wmsTimeStr: formatMinutes(wmsTimeMins),
                latestFinishMins: latestFinishTimeForNextJob
            };

            currentSchedule.push(newAppointment);
            renderSchedule();
            resetFormFields(pageElement);
        }

        /**
         * NEW: Handles the "Calculate" button click on the Duration Calculator page
         */
        function handleCalculateDuration(e) {
            e.preventDefault();
            
            const pageElement = document.getElementById('page-calculator');
            const resultsWrapper = pageElement.querySelector('#duration-results-wrapper');
            const placeholder = pageElement.querySelector('#duration-placeholder');

            // 1. Get all form inputs
            const contextCatId = pageElement.querySelector('#context-select').value;
            const bedrooms = parseInt(pageElement.querySelector('#calc-bedrooms').value) || 0;
            if (bedrooms === 0) {
                showModal("Please enter a valid number of bedrooms.");
                return;
            }
            if (bedrooms >= 7) {
                showModal("Advisory: You have selected a 7+ bedroom property. Please contact the photographer to confirm the estimated duration.");
            }
            const numFloors = parseInt(pageElement.querySelector('#calc-num-floors').value) || 1;
            
            const selectedProducts = [];
            pageElement.querySelectorAll('input[name="calc-product"]:checked').forEach(checkbox => {
                selectedProducts.push({
                    id: checkbox.value,
                    name: checkbox.nextElementSibling.textContent
                });
            });

            // 2. Validation
            if (!contextCatId) {
                showModal("Please select a context (Category or Photographer) first.");
                return;
            }
            if (bedrooms <= 0) {
                showModal("Please enter a valid number of bedrooms.");
                return;
            }
            if (selectedProducts.length === 0) {
                showModal("Please select at least one product.");
                return;
            }

            // 3. Get the ruleset for the *selected* context
            const selectedRuleset = timingCategories[contextCatId];
            const selectedContextName = pageElement.querySelector('#context-select option:checked').textContent;


            // 4. Run the main calculation for the selected context
            const totalTime = calculateDuration(bedrooms, selectedProducts, selectedRuleset, numFloors);
            
            // 5. Populate the main display
            pageElement.querySelector('#total-time-display').textContent = formatDuration(totalTime);
            pageElement.querySelector('#total-time-minutes').textContent = `(${totalTime} minutes)`;
            pageElement.querySelector('#selected-context-name').textContent = selectedContextName;
            
            // 6. Run the Category Comparison calculations
            const cat1Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat1'], numFloors);
            const cat2Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat2'], numFloors);
            const cat3Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat3'], numFloors);

            const comparisonWrapper = pageElement.querySelector('#category-comparison-display');
            comparisonWrapper.innerHTML = `
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat1' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat1' ? 'text-custom-green' : 'text-gray-700'}">Cat 1 (New Staff):</span>
                    <span class="font-bold ${contextCatId === 'cat1' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat1Time)}</span>
                </div>
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat2' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat2' ? 'text-custom-green' : 'text-gray-700'}">Cat 2 (Mid-Range):</span>
                    <span class="font-bold ${contextCatId === 'cat2' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat2Time)}</span>
                </div>
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat3' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat3' ? 'text-custom-green' : 'text-gray-700'}">Cat 3 (Experienced):</span>
                    <span class="font-bold ${contextCatId === 'cat3' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat3Time)}</span>
                </div>
            `;

            // 7. Get and Populate the Calculation Breakdown
            pageElement.querySelector('#breakdown-context-name').textContent = selectedContextName;
            const breakdownWrapper = pageElement.querySelector('#calculation-breakdown-display');
            const breakdownItems = getDurationBreakdown(bedrooms, selectedProducts, selectedRuleset, numFloors);
            breakdownWrapper.innerHTML = breakdownItems.map(item => `
                <div class="flex justify-between">
                    <span class="text-gray-600">${item.name}:</span>
                    <span class="font-medium text-gray-900">+${item.time} mins</span>
                </div>
            `).join('');
            
            if (breakdownItems.length === 0) {
                 breakdownWrapper.innerHTML = `<p class="text-gray-500">No products selected.</p>`;
            }

            // 8. Show the results
            placeholder.classList.add('hidden');
            resultsWrapper.classList.remove('hidden');
        }

        /**
         * NEW: Helper function to get the line-by-line breakdown for the calculator
         */
        function getDurationBreakdown(bedrooms, products, ruleset, numFloors) {
            let breakdown = [];
            const floorSurcharge = ruleset.floorSurcharge || 5;

            products.forEach(product => {
                const productId = product.id;
                
                if (ruleset.products.hasOwnProperty(productId)) {
                    const rules = ruleset.products[productId];
                    const rule = rules.sort((a, b) => a.maxBeds - b.maxBeds)
                                      .find(r => bedrooms <= r.maxBeds);
                    
                    if (rule) {
                        breakdown.push({ name: product.name, time: rule.time });
                    }

                    // Add 3D Showcase surcharge to breakdown
                    if (productId === 'showcase_3d') {
                        if (numFloors > 1) {
                            const surcharge = (numFloors - 1) * floorSurcharge;
                            if (surcharge > 0) {
                                breakdown.push({ name: `Floor Surcharge (${numFloors-1} extra)`, time: surcharge });
                            }
                        }
                    }
                }
            });

            return breakdown;
        }
        
        /**
         * Resets the entire schedule for the *current* photographer
         */
        function resetSchedule() {
            const page = diaryPages.find(p => p.id === currentPageId);
            if (!page || !page.photographerId) return;
            
            // BUG B (Ignored): This clears the shared data for the photographer.
            appointments[page.photographerId] = [];
            
            renderSchedule(); // Renders the now-empty schedule
            const pageElement = document.getElementById(currentPageId);
            resetFormFields(pageElement, true); // Force reset day start time
        }

    /**
     * NEW: Removes the last-added job from the current schedule
     */
    function handleDeleteLastJob(e) {
        const pageElement = e.target.closest('.sheet-content');
        const pageId = pageElement.id;
        const page = diaryPages.find(p => p.id === pageId);

        if (!page || !page.photographerId) return;

        const currentSchedule = appointments[page.photographerId];

        if (currentSchedule.length > 0) {
            // Remove the last job from the array
            currentSchedule.pop();

            // Redraw the table
            renderSchedule();

            // Reset the form fields to be ready for the next entry
            resetFormFields(pageElement, false);
        } else {
            showModal("Diary is already empty.");
        }
    }
        
        
        /**
         * Resets form fields, manages input enable/disable based on schedule
         */
        function resetFormFields(pageElement, forceResetDayStart = false) {
            const travelInput = pageElement.querySelector('#travel-time');
            const arrivalInput = pageElement.querySelector('#first-job-arrival-time');
            
            pageElement.querySelector('#bedrooms').value = '';
            pageElement.querySelectorAll('input[name="product"]:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            // Clear reference fields
            pageElement.querySelector('#ref-order-id').value = '';
            pageElement.querySelector('#ref-address').value = '';
            pageElement.querySelector('#ref-postcode').value = '';
            
            // Un-disable mutually exclusive checkboxes
            pageElement.querySelector(`input[data-product-id="standard_photos"]`).disabled = false;
            pageElement.querySelector(`input[data-product-id="premium_photos"]`).disabled = false;
            pageElement.querySelector(`input[data-product-id="capture_photos"]`).disabled = false;
            
            // Hide floor input
            toggleFloorInput(pageElement);


            const page = diaryPages.find(p => p.id === currentPageId);
            // BUG B (Ignored): We check the shared schedule for the photographer.
            const currentSchedule = page && page.photographerId ? appointments[page.photographerId] : [];

            if (forceResetDayStart || !currentSchedule || currentSchedule.length === 0) {
                // This is for the FIRST job
                arrivalInput.disabled = false;
                arrivalInput.value = "09:00";
                
                travelInput.disabled = true; // Disable travel
                travelInput.value = ''; // Clear and show placeholder
                travelInput.placeholder = 'N/A for first job';
                
            } else {
                // This is for SUBSEQUENT jobs
                arrivalInput.disabled = true; // Lock the arrival time
                
                travelInput.disabled = false; // Enable travel
                travelInput.value = '';
                travelInput.placeholder = 'e.g., 30'; // Show normal placeholder
            }
        }

        /**
         * Calculate the total on-site duration based on bedrooms and products
         */
        function calculateDuration(bedrooms, products, ruleset, numFloors) {
            let totalDuration = 0;
            const floorSurcharge = ruleset.floorSurcharge || 5;
            
            // Helper to find time for a specific product ID
            const getTime = (pId) => {
                if (!ruleset.products.hasOwnProperty(pId)) return 0;
                const rules = ruleset.products[pId];
                const rule = rules.sort((a, b) => a.maxBeds - b.maxBeds).find(r => bedrooms <= r.maxBeds);
                return rule ? rule.time : 0;
            };

            // Track which products we have processed to avoid double counting
            const processedIds = new Set();
            const productIds = products.map(p => p.id);

            // --- COMBINED LOGIC 1: Floorplan + EPC ---
            if (productIds.includes('floorplan') && productIds.includes('epc')) {
                const timeFP = getTime('floorplan');
                const timeEPC = getTime('epc');
                // Sum and divide by 1.5, round to nearest whole number
                totalDuration += Math.round((timeFP + timeEPC) / 1.5);
                processedIds.add('floorplan');
                processedIds.add('epc');
            }

            // --- COMBINED LOGIC 2: Drone Photo + Drone Video ---
            if (productIds.includes('drone_photos') && productIds.includes('drone_video')) {
                const timeDP = getTime('drone_photos');
                const timeDV = getTime('drone_video');
                totalDuration += Math.round((timeDP + timeDV) / 1.5);
                processedIds.add('drone_photos');
                processedIds.add('drone_video');
            }

            // --- PROCESS REMAINING PRODUCTS ---
            products.forEach(product => {
                if (!processedIds.has(product.id)) {
                    const time = getTime(product.id);
                    totalDuration += time;

                    // 3D Showcase Surcharge Logic
                    if (product.id === 'showcase_3d' && numFloors > 1) {
                        totalDuration += (numFloors - 1) * floorSurcharge;
                    }
                }
            });

            return totalDuration;
        }

        /**
         * Re-draw the schedule table for the *current* photographer
         */
        function renderSchedule() {
            const pageElement = document.getElementById(currentPageId);
            if (!pageElement || !pageElement.querySelector) return; // Check if page exists
            const tbody = pageElement.querySelector('#schedule-body');
            tbody.innerHTML = ''; // Clear table

            const page = diaryPages.find(p => p.id === currentPageId);
            if (!page || !page.photographerId) return;
            
            // BUG B (Ignored): We get the shared schedule for the photographer.
            const currentSchedule = appointments[page.photographerId];
            
            currentSchedule.forEach((appt, index) => {
                const arrivalDisplay = `${appt.arrivalStr} / ${appt.arrivalWindowEndStr}`;
                const finishDisplay = `${appt.finishTimeStr} / ${appt.finishWindowEndStr}`;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${index + 1}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 100px;" title="${appt.orderRef}">${appt.orderRef}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 150px;" title="${appt.address}">${appt.address}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 80px;" title="${appt.postcode}">${appt.postcode}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.travel}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.buffer}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-custom-green">${arrivalDisplay}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-red-600">${appt.wmsTimeStr}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.bedrooms}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 150px;" title="${appt.productsStr}">${appt.productsStr}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatDuration(appt.duration)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-custom-finish">${finishDisplay}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                            <button class="text-gray-400 cursor-not-allowed" title="Full 'Edit' feature available in v1.0" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- UTILITY FUNCTIONS (Time-as-Minutes) ---

        /**
         * Converts "HH:MM" string to minutes-from-midnight
         */
        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        /**
         * Converts minutes-from-midnight to "HH:MM" string
         */
        function formatMinutes(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * Helper to format duration in minutes to h:mm string
         */
        function formatDuration(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * Rounds a number of minutes to the nearest interval
         */
        function roundToNearest(minutes, interval) {
            return Math.round(minutes / interval) * interval;
        }
        
        /**
         * NEW: Shows the tips modal
         */
        function showTipsModal() {
            const modal = document.getElementById('tips-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        /**
         * NEW: Closes the tips modal
         */
        function closeTipsModal() {
            const modal = document.getElementById('tips-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        /**
         * Shows a custom modal dialog
         */
        function showModal(message, onConfirm) {
            let modal = document.getElementById('alert-modal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'alert-modal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';

            const modalContent = document.createElement('div');
            modalContent.className = 'relative mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white';

            const text = document.createElement('p');
            text.className = 'text-gray-700 text-sm';
            text.textContent = message;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'text-right mt-4';

            if (onConfirm) {
                const confirmButton = document.createElement('button');
                confirmButton.className = 'px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green';
                confirmButton.textContent = 'Yes';
                confirmButton.onclick = function() {
                    onConfirm();
                    modal.remove();
                };
                buttonContainer.appendChild(confirmButton);

                const cancelButton = document.createElement('button');
                cancelButton.className = 'ml-2 px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400';
                cancelButton.textContent = 'No';
                cancelButton.onclick = function() {
                    modal.remove();
                };
                buttonContainer.appendChild(cancelButton);
                confirmButton.focus();
            } else {
                const closeButton = document.createElement('button');
                closeButton.className = 'px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green';
                closeButton.textContent = 'OK';
                closeButton.onclick = function() {
                    modal.remove();
                };
                buttonContainer.appendChild(closeButton);
                closeButton.focus();
            }

            modalContent.appendChild(text);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // --- START THE APP ---
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
