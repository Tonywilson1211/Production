<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photography Diary Manager (PoC v0.9)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Heroicons for icons -->
    <script type="module" src="https://unpkg.com/heroicons@2.1.1/24/outline/index.js"></script>
    
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for active tab */
        .tab.active {
            border-top: 4px solid #93be1e; /* Custom Green */
            background-color: #f9fafb; /* gray-50 */
            color: #93be1e; /* Custom Green */
        }
        .tab {
            border-top: 4px solid transparent;
        }
        /* Hide scrollbars for number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Style for disabled inputs */
        input:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
            color: #9ca3af; /* gray-400 */
        }

        /* Define custom green colors for Tailwind's JIT mode */
        .bg-custom-green { background-color: #93be1e; }
        .hover\:bg-custom-green-dark:hover { background-color: #7aa518; } /* Slightly darker for hover */
        .focus\:ring-custom-green:focus { --tw-ring-color: #93be1e; }
        .text-custom-green { color: #93be1e; }
        .border-custom-green { border-color: #93be1e; }
        .text-custom-green { color: #93be1e; }
        .focus\:border-custom-green:focus { border-color: #93be1e; }
        .focus\:ring-custom-green:focus { box-shadow: 0 0 0 2px #93be1e; }
        .text-custom-green { color: #93be1e; }
        .focus\:ring-custom-green:focus { --tw-ring-color: #93be1e; }
        
        /* NEW: Custom color for the finish window */
        .text-custom-finish { color: #c4d787; }


    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">

    <!-- Header with Logo -->
    <header class="bg-white shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center">
            <!-- Logo Placeholder -->
            <div class="h-8 w-8 bg-custom-green rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                <img src="https://placehold.co/32x32/93be1e/ffffff/png?text=DBA" alt="Company Logo" class="h-8 w-8 rounded-full">
            </div>
            <h1 class="text-xl font-semibold text-gray-800">Diary Booking Assistant</h1>
        </div>
        <!-- You can add other header elements here if needed -->
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8 overflow-auto">
        
        <!-- Page 1: Staff Hub (New Mockup Page) -->
        <div id="page-staff-hub" class="sheet-content bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Team & Staff Hub</h1>
            
            <!-- Team Selection (Mockup) -->
            <div class="mb-6">
                <label for="team-select" class="block text-sm font-medium text-gray-700">Select Team (Area)</label>
                <select id="team-select" class="mt-1 block w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                    <option selected>Orbital - Area 2</option>
                    <option disabled>Area 2 - South East (v1.0 Feature)</option>
                    <option disabled>Area 3 - Midlands (v1.0 Feature)</option>
                </select>
            </div>

            <!-- Staff List (Mockup) -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Staff List: Orbital - Area 2</h2>
                <button class="px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark" disabled>Add New Staff (Full v1.0 Feature)</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Category</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">James Wilson</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option selected>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Paul Udgaranya</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">William Howe</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option>Cat 2</option>
                                    <option selected>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Kacper Chodyra</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <select class="border-gray-300 rounded-md" disabled>
                                    <option>Cat 1</option>
                                    <option selected>Cat 2</option>
                                    <option>Cat 3</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="text-red-600 hover:text-red-900" disabled>Remove (Full v1.0 Feature)</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="mt-4 text-sm text-gray-500 italic">This is a mock-up of the v1.0 "Staff Hub." In the full version, managers can add/remove staff and assign custom categories.</p>
        </div>


        <!-- Page 2: Key -->
        <div id="page-key" class="sheet-content hidden bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Timing Assumptions Key</h1>
            <p class="text-sm text-gray-600 mb-6">This shows the rules for the "Standard" categories. The v1.0 app will allow managers to create custom categories.</p>
            <div id="key-categories-container" class="space-y-10">
                <!-- Category details will be injected by JS -->
            </div>
        </div>

        <!-- Page 4: Duration Calculator (NEW) -->
        <div id="page-calculator" class="sheet-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Input Form -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Duration Calculator</h2>
                    <p class="text-sm text-gray-600 mb-4">A quick-lookup tool to estimate on-site time for a job.</p>
                    
                    <form id="calculator-form" class="space-y-4">
                        <!-- Context Dropdown -->
                        <div>
                            <label for="context-select" class="block text-sm font-medium text-gray-700">Select Context</label>
                            <select id="context-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                                <!-- Options will be injected by JS -->
                            </select>
                        </div>
                        
                        <!-- Bedrooms -->
                        <div>
                            <label for="calc-bedrooms" class="block text-sm font-medium text-gray-700">Property Size (Bedrooms)</label>
                            <input type="number" id="calc-bedrooms" min="1" value="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 3">
                        </div>

                        <!-- Floors -->
                        <div id="calc-floors-wrapper" class="floors-input-wrapper hidden">
                            <label for="calc-num-floors" class="block text-sm font-medium text-gray-700">Number of Floors (for 3D)</label>
                            <input type="number" id="calc-num-floors" name="num-floors" min="1" value="1" class="num-floors-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                        </div>
                        
                        <!-- Products -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Products</label>
                            <div class="mt-2 space-y-2 h-48 overflow-y-auto border p-2 rounded-md" id="calc-products-list">
                                <!-- Checkboxes will be injected by JS -->
                            </div>
                        </div>

                        <!-- Calculate Button -->
                        <div class="pt-4">
                            <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                Calculate Duration
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Results Panel -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Calculation Results</h2>
                    <div id="duration-results-wrapper" class="hidden space-y-6">
                        
                        <!-- Total Time Display -->
                        <div class="text-center bg-custom-green text-white p-6 rounded-lg shadow">
                            <label class="block text-sm font-medium uppercase tracking-wider">Total On-Site Time (for <span id="selected-context-name">Cat 2</span>)</label>
                            <p id="total-time-display" class="text-5xl font-bold">1h 20m</p>
                            <p id="total-time-minutes" class="text-lg">(80 minutes)</p>
                        </div>
                        
                        <!-- Category Comparison -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Category Comparison</h3>
                            <div id="category-comparison-display" class="space-y-2">
                                <!-- Comparison rows will be injected by JS -->
                            </div>
                        </div>
                        
                        <!-- Calculation Breakdown -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Calculation Breakdown (<span id="breakdown-context-name">Cat 2</span>)</h3>
                            <div id="calculation-breakdown-display" class="text-sm space-y-2 p-4 bg-gray-50 rounded-md border">
                                <!-- Breakdown items will be injected by JS -->
                            </div>
                        </div>
                    </div>
                    <p id="duration-placeholder" class="text-gray-500">Please select your inputs and click "Calculate" to see the results.</p>
                </div>
            </div>
        </div>

        <!-- Page 3: Photographer Calculator -->
        <div id="page-diary" class="sheet-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Input Form -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">New Appointment</h2>
                    
                    <!-- NEW: Photographer Selection Dropdown -->
                    <div class="mb-4">
                        <label for="photographer-select" class="block text-sm font-medium text-gray-700">1. Select Photographer</label>
                        <select id="photographer-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            <option value="" disabled selected>Select a photographer...</option>
                            <!-- Options will be injected by JS -->
                        </select>
                        <p id="photographer-category-display" class="mt-1 text-sm text-custom-green font-medium"></p>
                    </div>

                    <form id="appointment-form" class="space-y-4">
                        <div class="opacity-50" id="form-fields-wrapper">
                            <!-- Optional Reference Fields -->
                            <div class="p-4 bg-gray-50 rounded-md border mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Optional (v1.0 Reference)</p>
                                <div class="space-y-2">
                                    <input type="text" id="ref-order-id" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="Order Reference">
                                    <input type="text" id="ref-address" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="First Line of Address">
                                    <input type="text" id="ref-postcode" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="Postcode">
                                </div>
                            </div>
                            
                            <!-- Main Calculator Fields -->
                            <div>
                                <label for="first-job-arrival-time" class="block text-sm font-medium text-gray-700">First Job Arrival (8am-5pm)</label>
                                <input type="time" id="first-job-arrival-time" value="09:00" min="08:00" max="17:00" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            </div>
                            
                            <div>
                                <label for="travel-time" class="block text-sm font-medium text-gray-700">Travel Time (mins)</label>
                                <input type="number" id="travel-time" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 30">
                            </div>

                            <div>
                                <label for="bedrooms" class="block text-sm font-medium text-gray-700">Property Size (Bedrooms)</label>
                                <input type="number" id="bedrooms" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green" placeholder="e.g., 3">
                            </div>

                            <!-- NEW: Number of Floors (for 3D Showcase) -->
                            <div class="floors-input-wrapper hidden">
                                <label for="num-floors" class="block text-sm font-medium text-gray-700">Number of Floors (for 3D)</label>
                                <input type="number" name="num-floors" min="1" value="1" class="num-floors-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-custom-green focus:border-custom-green">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">Products</label>
                                <div class="mt-2 space-y-2 h-32 overflow-y-auto border p-2 rounded-md" id="products-list">
                                    <!-- Checkboxes will be injected by JS -->
                                </div>
                            </div>

                            <!-- v1.0 Features (Mocked) -->
                            <div class="space-y-2 pt-2">
                                <label for="additional-time" class="block text-sm font-medium text-gray-700">Additional Time (Full v1.0 Feature)</label>
                                <input type="number" id="additional-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 15 mins (disabled)" disabled>
                                
                                <div class="flex items-center">
                                    <input id="ad-hoc-job" name="ad-hoc-job" type="checkbox" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green" disabled>
                                    <label for="ad-hoc-job" class="ml-2 block text-sm text-gray-700">Ad-Hoc Job (Full v1.0 Feature)</label>
                                </div>
                            </div>

                            <div class="flex justify-between pt-4">
                                <button type="submit" class="w-2/3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                    Add Appointment
                                </button>
                                <button type="button" id="reset-schedule" class="w-1/3 ml-3 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Schedule Table -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 id="schedule-title" class="text-xl font-bold text-gray-800 mb-6">Calculated Schedule</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job #</th>
                                    <!-- Optional v1.0 Reference Columns -->
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Ref</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postcode</th>
                                    <!-- Core Calculator Columns -->
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Travel</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buffer</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrival (Window)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WMS</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beds</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration (h:mm)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finish (Window)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="schedule-body">
                                <!-- Schedule rows will be injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Tab Navigation -->
    <!-- FIX: Removed overflow-x-auto to prevent tab bar from shrinking -->
    <nav id="tab-navigation" class="flex border-t border-gray-300 bg-white shadow-inner">
        <!-- Tabs will be injected by JS -->
    </nav>

    <script>
        // --- DATA & ASSUMPTIONS ---

        // 30-minute arrival window buffer
        const ARRIVAL_WINDOW_BUFFER = 30;

        // Categories. Cat 1 is new (slower), Cat 2 is standard, Cat 3 is fast.
        const timingCategories = {
            cat1: {
                name: "Cat 1 (New Staff)",
                travelBuffer: 15,
                floorSurcharge: 10, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'premium_photos': [ { maxBeds: 2, time: 60 }, { maxBeds: 4, time: 70 }, { maxBeds: 6, time: 80 }, { maxBeds: Infinity, time: 90 } ],
                    'floorplan': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'epc': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'video': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 35 }, { maxBeds: Infinity, time: 35 } ],
                    'drone_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 40 } ],
                    'drone_video': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 35 }, { maxBeds: 6, time: 45 }, { maxBeds: Infinity, time: 45 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'elevated_single': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 20 }, { maxBeds: Infinity, time: 20 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'video_presented': [ { maxBeds: 2, time: 55 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 65 } ]
                }
            },
            cat2: {
                name: "Cat 2 (Mid-Range)",
                travelBuffer: 10,
                floorSurcharge: 5, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'premium_photos': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 55 }, { maxBeds: 6, time: 65 }, { maxBeds: Infinity, time: 75 } ],
                    'floorplan': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'epc': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'video': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'drone_photos': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'drone_video': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 35 }, { maxBeds: Infinity, time: 35 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 40 }, { maxBeds: 4, time: 50 }, { maxBeds: 6, time: 60 }, { maxBeds: Infinity, time: 70 } ],
                    'elevated_single': [ { maxBeds: 2, time: 15 }, { maxBeds: 4, time: 15 }, { maxBeds: 6, time: 15 }, { maxBeds: Infinity, time: 15 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'video_presented': [ { maxBeds: 2, time: 45 }, { maxBeds: 4, time: 45 }, { maxBeds: 6, time: 55 }, { maxBeds: Infinity, time: 55 } ]
                }
            },
            cat3: {
                name: "Cat 3 (Experienced)",
                travelBuffer: 10,
                floorSurcharge: 5, // Surcharge per floor for 3D Showcase
                products: {
                    'standard_photos': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 35 }, { maxBeds: 6, time: 45 }, { maxBeds: Infinity, time: 55 } ],
                    'premium_photos': [ { maxBeds: 2, time: 30 }, { maxBeds: 4, time: 40 }, { maxBeds: 6, time: 50 }, { maxBeds: Infinity, time: 60 } ],
                    'floorplan': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 50 } ],
                    'epc': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 30 }, { maxBeds: 6, time: 40 }, { maxBeds: Infinity, time: 50 } ],
                    'video': [ { maxBeds: 2, time: 15 }, { maxBeds: 4, time: 15 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'drone_photos': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 25 }, { maxBeds: Infinity, time: 25 } ],
                    'drone_video': [ { maxBeds: 2, time: 25 }, { maxBeds: 4, time: 25 }, { maxBeds: 6, time: 30 }, { maxBeds: Infinity, time: 30 } ],
                    'showcase_3d': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 45 }, { maxBeds: 6, time: 55 }, { maxBeds: Infinity, time: 65 } ],
                    'elevated_single': [ { maxBeds: 2, time: 10 }, { maxBeds: 4, time: 10 }, { maxBeds: 6, time: 10 }, { maxBeds: Infinity, time: 10 } ],
                    'elevated_multi': [ { maxBeds: 2, time: 20 }, { maxBeds: 4, time: 20 }, { maxBeds: 6, time: 20 }, { maxBeds: Infinity, time: 20 } ],
                    'video_presented': [ { maxBeds: 2, time: 35 }, { maxBeds: 4, time: 35 }, { maxBeds: 6, time: 45 }, { maxBeds: Infinity, time: 45 } ]
                }
            }
        };

        // Hard-coded photographer list
        let photographerProfiles = {
            p1: { name: "James Wilson", category: 'cat1' },
            p2: { name: "Paul Udgaranya", category: 'cat2' },
            p3: { name: "William Howe", category: 'cat3' },
            p4: { name: "Kacper Chodyra", category: 'cat2' },
        };
        
        // List of all products offered
        const productList = [
            { id: 'standard_photos', name: 'Standard Photography' },
            { id: 'premium_photos', name: 'Premium Photography' },
            { id: 'floorplan', name: 'Floorplan' },
            { id: 'epc', name: 'EPC' },
            { id: 'video', name: 'Property Video' },
            { id: 'drone_photos', name: 'Drone Photography' },
            { id: 'drone_video', name: 'Drone Video' },
            { id: 'showcase_3d', name: '3D Showcase' },
            { id:'elevated_single', name: 'Elevated (Single)' },
            { id:'elevated_multi', name: 'Elevated (Multi)' },
            { id: 'video_presented', name: 'Property Video (Presented)' }
        ];

        // --- GLOBAL STATE ---
        
        let appointments = {};
        let diaryPages = []; // NEW: Array to hold diary page states
        let currentPageId = null; // NEW: To track the active page

        // --- CORE FUNCTIONS ---

        /**
         * Initialize the application
         */
        function init() {
            // Initialize appointment array for each photographer
            for (const photoId in photographerProfiles) {
                if (photographerProfiles.hasOwnProperty(photoId)) {
                    appointments[photoId] = [];
                }
            }

            addNewDiaryPage(); // Add the first diary page
            populateMainTabs();
            populateKeySheet();
            populateProductsList(document.getElementById('page-diary-0'));
            populatePhotographerDropdown(document.getElementById('page-diary-0').querySelector('#photographer-select'));

            document.getElementById('page-diary-0').querySelector('#appointment-form').addEventListener('submit', handleAddAppointment);
            document.getElementById('page-diary-0').querySelector('#reset-schedule').addEventListener('click', resetSchedule);
            document.getElementById('page-diary-0').querySelector('#photographer-select').addEventListener('change', selectPhotographer);

            // Setup for new Duration Calculator page
            populateContextDropdown();
            populateCalcProductsList();
            toggleCalcFloorInput(document.getElementById('page-calculator')); // Initial check
            document.getElementById('calculator-form').addEventListener('submit', handleCalculateDuration);

            // Show the 'Staff Hub' sheet by default
            switchSheet('page-staff-hub');
        }

        function addNewDiaryPage() {
            const newPageId = `page-diary-${diaryPages.length}`;
            const newPage = {
                id: newPageId,
                photographerId: null,
                name: "Diary Booking"
            };
            diaryPages.push(newPage);

            const mainContent = document.querySelector('main');
            const diaryPageClone = document.getElementById('page-diary').cloneNode(true);
            diaryPageClone.id = newPageId;
            diaryPageClone.classList.add('hidden');

            if (diaryPages.length > 1) {
                const closeButton = document.createElement('button');
                closeButton.className = "absolute top-0 right-0 p-2 text-gray-500 hover:text-red-600";
                closeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                closeButton.addEventListener('click', () => closeDiaryPage(newPageId));
                
                const scheduleTitle = diaryPageClone.querySelector('#schedule-title');
                scheduleTitle.parentNode.style.position = 'relative';
                scheduleTitle.parentNode.appendChild(closeButton);
            }

            mainContent.appendChild(diaryPageClone);

            populateProductsList(diaryPageClone);
            const newPhotographerSelect = diaryPageClone.querySelector('#photographer-select');
            populatePhotographerDropdown(newPhotographerSelect);
            newPhotographerSelect.addEventListener('change', selectPhotographer);

            diaryPageClone.querySelector('#appointment-form').addEventListener('submit', handleAddAppointment);
            diaryPageClone.querySelector('#reset-schedule').addEventListener('click', resetSchedule);


            currentPageId = newPageId;
            populateMainTabs();
            switchSheet(newPageId);
            toggleFloorInput(diaryPageClone); // Ensure floors input is hidden on new page
        }

        function closeDiaryPage(pageId) {
            showModal("Are you sure you want to close this page?", () => {
                const pageIndex = diaryPages.findIndex(p => p.id === pageId);
                if (pageIndex > -1) {
                    diaryPages.splice(pageIndex, 1);
                    const pageElement = document.getElementById(pageId);
                    if (pageElement) {
                        pageElement.remove();
                    }
                    populateMainTabs();
                    if (currentPageId === pageId) {
                        switchSheet('page-staff-hub');
                    }
                }
            });
        }
        
        /**
         * Create tabs for the 3 main pages
         */
        function populateMainTabs() {
            const nav = document.getElementById('tab-navigation');
            nav.innerHTML = ''; // Clear existing tabs

            const staticPages = [
                { id: 'page-staff-hub', name: 'Staff Hub', icon: 'users' },
                { id: 'page-key', name: 'Key', icon: 'key' },
                { id: 'page-calculator', name: 'Duration Calculator', icon: 'calculator' }, // <-- NEW PAGE
                { id: 'page-diary-0', name: 'Diary Booking', icon: 'calendar-days' } // <-- UPDATED ID
            ];

            const allPages = [...staticPages];

            allPages.forEach(page => {
                const tab = document.createElement('button');
                tab.dataset.sheet = page.id;
                tab.className = 'tab flex-1 p-4 text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-custom-green focus:outline-none flex items-center justify-center';
                
                let iconSvg = '';
                if (page.icon === 'users') {
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372m.375-3.72a9.375 9.375 0 0 0-3.75 0m5.625 3.72a9.375 9.375 0 0 1-3.75 0M3.375 19.128a9.375 9.375 0 0 1 3.75 0m5.625 3.72a9.375 9.375 0 0 0-3.75 0m3.75-3.72a9.375 9.375 0 0 0 3.75 0m-9.375 3.72a9.375 9.375 0 0 1-3.75 0M14.625 12a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm-3.375 0a.375.375 0 0 0-.375.375v.375c0 .207.168.375.375.375h.375a.375.375 0 0 0 .375-.375v-.375a.375.375 0 0 0-.375-.375h-.375Z" /></svg>';
                } else if (page.icon === 'key') {
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" /></svg>';
                } else if (page.icon === 'calculator') {
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25v-.008Zm0 2.25h.008v.008H8.25v-.008Zm2.25-4.5h.008v.008H10.5v-.008Zm0 2.25h.008v.008H10.5v-.008Zm0 2.25h.008v.008H10.5v-.008Zm2.25-4.5h.008v.008H12.75v-.008Zm0 2.25h.008v.008H12.75v-.008Zm0 2.25h.008v.008H12.75v-.008Zm2.25-4.5h.008v.008H15v-.008Zm0 2.25h.008v.008H15v-.008Zm0 2.25h.008v.008H15v-.008Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h18M3 21h18v-3H3v3Zm0-3h18V6H3v12Z" /></svg>';
                } else if (page.icon === 'calendar-days') {
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>';
                }
                
                tab.innerHTML = `${iconSvg} ${page.name}`;
                tab.addEventListener('click', () => switchSheet(page.id));
                nav.appendChild(tab);
            });

            const addTab = document.createElement('button');
            addTab.className = 'p-4 text-sm font-medium text-white bg-custom-green hover:bg-custom-green-dark focus:outline-none flex items-center justify-center';
            addTab.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>';
            addTab.addEventListener('click', addNewDiaryPage);
            nav.appendChild(addTab);
        }

        /**
         * Switch between the 'sheets'
         */
        function switchSheet(sheetId) {
            currentPageId = sheetId;
            // Hide all sheets
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.add('hidden');
            });
            // Show the selected one
            const pageElement = document.getElementById(sheetId);
            pageElement.classList.remove('hidden');

            // Update tab active state
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.sheet === sheetId) {
                    tab.classList.add('active');
                }
            });

            const page = diaryPages.find(p => p.id === sheetId);
            if (page) {
                disableCalculatorForm(pageElement, !page.photographerId);
            }
        }

        /**
         * Populate the photographer dropdown on the Diary page
         */
        function populatePhotographerDropdown(selectElement) {
            selectElement.innerHTML = '<option value="" disabled selected>Select a photographer...</option>';
            for (const photoId in photographerProfiles) {
                const profile = photographerProfiles[photoId];
                const option = document.createElement('option');
                option.value = photoId;
                option.textContent = profile.name;
            }
        }
        
        /**
         * NEW: Populates the dropdown on the Duration Calculator page
         */
        function populateContextDropdown() {
            const select = document.getElementById('context-select');
            select.innerHTML = ''; // Clear options

            // Add Generic Categories
            select.innerHTML += `<option value="" disabled selected>Select a context...</option>`;
            select.innerHTML += `<optgroup label="Generic Categories">`;
            for (const catId in timingCategories) {
                const category = timingCategories[catId];
                const option = document.createElement('option');
                option.value = catId; // e.g., "cat1"
                option.textContent = category.name;
                select.querySelector('optgroup[label="Generic Categories"]').appendChild(option);
            }
            select.innerHTML += `</optgroup>`;

            // Add Photographers
            select.innerHTML += `<optgroup label="Photographers">`;
            for (const photoId in photographerProfiles) {
                const profile = photographerProfiles[photoId];
                const category = timingCategories[profile.category];
                const option = document.createElement('option');
                option.value = profile.category; // e.g., "cat1"
                option.textContent = `${profile.name} (${category.name})`;
                select.querySelector('optgroup[label="Photographers"]').appendChild(option);
            }
            select.innerHTML += `</optgroup>`;
        }        /**
         * Populate the 'Key' sheet with tables for *all* categories
         */
        function populateKeySheet() {
            const container = document.getElementById('key-categories-container');
            container.innerHTML = ''; // Clear existing
            
            // Helper to find a product's name from its ID
            const getProductName = (id) => productList.find(p => p.id === id)?.name || id;

            for (const catId in timingCategories) {
                const category = timingCategories[catId];
                const categoryBlock = document.createElement('div');
                categoryBlock.className = 'border border-gray-200 rounded-lg p-6';
                
                let html = `<h2 class="text-xl font-bold text-custom-green mb-4">${category.name}</h2>`;
                
                // General Table
                html += `
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">General</h3>
                    <table class="min-w-full divide-y divide-gray-200 mb-6">
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Travel Time Buffer</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${category.travelBuffer} mins</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                // Products Breakdown
                html += `<h3 class="text-lg font-semibold text-gray-700 mb-4 border-t pt-4">Product Timings</h3>`;
                html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                
                // Loop through each product ID in the productList to maintain order
                productList.forEach(product => {
                    const productId = product.id;
                    if (category.products.hasOwnProperty(productId)) {
                        const rules = category.products[productId];
                        const productName = product.name;
                        
                        html += `<div class="border border-gray-200 rounded-lg p-4 bg-gray-50">`;
                        html += `<h4 class="font-semibold text-gray-800 mb-3">${productName}</h4>`;
                        html += `<ul class="list-none space-y-2">`;
                        
                        let lastBeds = 0;
                        rules.forEach(rule => {
                            let bedRange = '';
                            if (rule.maxBeds === Infinity) {
                                // This is the "translation" logic we discussed
                                bedRange = `${lastBeds + 1}+ beds`;
                            } else {
                                bedRange = `${lastBeds + 1} - ${rule.maxBeds} beds`;
                            }
                            // Handle 0-bed (e.g., 1-2 beds)
                            if (lastBeds === 0) {
                                bedRange = `Up to ${rule.maxBeds} beds`;
                            }

                            lastBeds = rule.maxBeds;
                            
                            html += `<li class="flex justify-between text-sm">
                                         <span class="text-gray-600">${bedRange}:</span>
                                         <span class="font-medium text-gray-900">${rule.time} mins</span>
                                     </li>`;
                        });

                        // Add 3D Showcase floor logic note
                        if (productId === 'showcase_3d') {
                             html += `<li class="text-xs text-gray-500 italic pt-2 border-t mt-2">
                                         +${category.floorSurcharge} mins per additional floor
                                     </li>`;
                        }
                        
                        html += `</ul></div>`;
                    }
                });
                
                html += `</div>`; // Close grid
                categoryBlock.innerHTML = html;
                container.appendChild(categoryBlock);
            }
        }
        
        /**
         * Populate the checkboxes for products on the form
         */
        function populateProductsList(pageElement) {
            const listDiv = pageElement.querySelector('#products-list');
            const pageId = pageElement.id;
            listDiv.innerHTML = '';
            
            productList.forEach(product => {
                const productId = `${product.id}-${pageId}`; // Unique ID for the checkbox
                const item = `
                    <div class="flex items-center">
                        <input id="${productId}" name="product" type="checkbox" value="${product.id}" data-product-id="${product.id}" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green product-checkbox">
                        <label for="${productId}" class="ml-3 block text-sm text-gray-700">${product.name}</label>
                    </div>
                `;
                listDiv.innerHTML += item;
            });

            // --- MUTUAL EXCLUSION LOGIC (Standard vs. Premium) ---
            const standardPhotosCheckbox = pageElement.querySelector(`input[data-product-id="standard_photos"]`);
            const premiumPhotosCheckbox = pageElement.querySelector(`input[data-product-id="premium_photos"]`);

            standardPhotosCheckbox.addEventListener('change', () => {
                if (standardPhotosCheckbox.checked) {
                    premiumPhotosCheckbox.disabled = true;
                    premiumPhotosCheckbox.checked = false; // Uncheck it
                } else {
                    premiumPhotosCheckbox.disabled = false;
                }
            });

            premiumPhotosCheckbox.addEventListener('change', () => {
                if (premiumPhotosCheckbox.checked) {
                    standardPhotosCheckbox.disabled = true;
                    standardPhotosCheckbox.checked = false; // Uncheck it
                } else {
                    standardPhotosCheckbox.disabled = false;
                }
            });

            // --- NEW: 3D SHOWCASE FLOOR INPUT LOGIC ---
            // Attach listener to all checkboxes to check for the 3D showcase
            pageElement.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => toggleFloorInput(pageElement));
            });
        }

        /**
         * NEW: Populates the product list on the Duration Calculator page
         */
        function populateCalcProductsList() {
            const pageElement = document.getElementById('page-calculator');
            const listDiv = pageElement.querySelector('#calc-products-list');
            const pageId = 'calculator-page'; // Unique static ID
            listDiv.innerHTML = '';
            
            productList.forEach(product => {
                const productId = `${product.id}-${pageId}`; // Unique ID for the checkbox
                const item = `
                    <div class="flex items-center">
                        <input id="${productId}" name="calc-product" type="checkbox" value="${product.id}" data-product-id="${product.id}" class="h-4 w-4 text-custom-green border-gray-300 rounded focus:ring-custom-green calc-product-checkbox">
                        <label for="${productId}" class="ml-3 block text-sm text-gray-700">${product.name}</label>
                    </div>
                `;
                listDiv.innerHTML += item;
            });

            // --- MUTUAL EXCLUSION LOGIC ---
            const standardPhotosCheckbox = pageElement.querySelector(`input[data-product-id="standard_photos"]`);
            const premiumPhotosCheckbox = pageElement.querySelector(`input[data-product-id="premium_photos"]`);

            standardPhotosCheckbox.addEventListener('change', () => {
                if (standardPhotosCheckbox.checked) {
                    premiumPhotosCheckbox.disabled = true;
                    premiumPhotosCheckbox.checked = false; // Uncheck it
                } else {
                    premiumPhotosCheckbox.disabled = false;
                }
            });

            premiumPhotosCheckbox.addEventListener('change', () => {
                if (premiumPhotosCheckbox.checked) {
                    standardPhotosCheckbox.disabled = true;
                    standardPhotosCheckbox.checked = false; // Uncheck it
                } else {
                    standardPhotosCheckbox.disabled = false;
                }
            });

            // --- 3D SHOWCASE FLOOR INPUT LOGIC ---
            pageElement.querySelectorAll('.calc-product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => toggleCalcFloorInput(pageElement));
            });
        }

        /**
         * NEW: Show/Hide the "Number of Floors" input based on 3D Showcase
         */
        function toggleFloorInput(pageElement) {
            // Find the elements *within the specific page*
            const showcaseCheckbox = pageElement.querySelector(`input[data-product-id="showcase_3d"]`);
            const floorsWrapper = pageElement.querySelector('.floors-input-wrapper');
            
            if (showcaseCheckbox && showcaseCheckbox.checked) {
                floorsWrapper.classList.remove('hidden');
            } else {
                floorsWrapper.classList.add('hidden');
                pageElement.querySelector('.num-floors-input').value = 1; // Reset to 1 when hidden
            }
        }

        /**
         * NEW: Show/Hide the "Number of Floors" input on the Calculator page
         */
        function toggleCalcFloorInput(pageElement) {
            // Find the elements *within the calculator page*
            const showcaseCheckbox = pageElement.querySelector(`input[data-product-id="showcase_3d"]`);
            const floorsWrapper = pageElement.querySelector('#calc-floors-wrapper');
            
            if (showcaseCheckbox && showcaseCheckbox.checked) {
                floorsWrapper.classList.remove('hidden');
            } else {
                floorsWrapper.classList.add('hidden');
                pageElement.querySelector('#calc-num-floors').value = 1; // Reset to 1 when hidden
            }
        }

        /**
         * Handle selecting a photographer from the dropdown
         */
        function selectPhotographer(e) {
            const pageElement = e.target.closest('.sheet-content');
            const pageId = pageElement.id;
            const page = diaryPages.find(p => p.id === pageId);
            if (!page) return;

            page.photographerId = e.target.value;
            if (page.photographerId) {
                const profile = photographerProfiles[page.photographerId];
                page.name = `Diary Booking - ${profile.name}`;
                disableCalculatorForm(pageElement, false);
                pageElement.querySelector('#schedule-title').textContent = `Calculated Schedule: ${profile.name}`;
                pageElement.querySelector('#photographer-category-display').textContent = `Using Category: ${timingCategories[profile.category].name}`;
            } else {
                page.name = "Diary Booking";
                disableCalculatorForm(pageElement, true);
                pageElement.querySelector('#schedule-title').textContent = `Calculated Schedule`;
                pageElement.querySelector('#photographer-category-display').textContent = ``;
            }
            populateMainTabs();
            renderSchedule();
            resetFormFields(pageElement);
        }

        /**
         * Enable/disable the calculator form
         */
        function disableCalculatorForm(pageElement, disabled) {
            const wrapper = pageElement.querySelector('#form-fields-wrapper');
            if (disabled) {
                wrapper.classList.add('opacity-50', 'pointer-events-none');
            } else {
                wrapper.classList.remove('opacity-50', 'pointer-events-none');
            }
        }


        /**
         * Handle the form submission to add a new appointment
         */
        function handleAddAppointment(e) {
            e.preventDefault();
            
            const pageElement = e.target.closest('.sheet-content');
            const pageId = pageElement.id;
            const page = diaryPages.find(p => p.id === pageId);
            if (!page || !page.photographerId) {
                showModal("Please select a photographer first.");
                return;
            }
            
            // --- TIME LOGIC: Use "time-as-minutes" math, not Date() objects ---
            // This is the "Path B" logic we agreed on.
            
            // 1. Get all form values
            const bedrooms = parseInt(pageElement.querySelector('#bedrooms').value) || 0;
            const travelTime = parseInt(pageElement.querySelector('#travel-time').value) || 0;
            const selectedProducts = [];
            pageElement.querySelectorAll('input[name="product"]:checked').forEach(checkbox => {
                selectedProducts.push({
                    id: checkbox.value,
                    name: checkbox.nextElementSibling.textContent,
                    type: checkbox.dataset.type
                });
            });
            // Get Optional Reference Fields
            const orderRef = pageElement.querySelector('#ref-order-id').value;
            const address = pageElement.querySelector('#ref-address').value;
            const postcode = pageElement.querySelector('#ref-postcode').value;


            // 2. Validation
            if (selectedProducts.length === 0) {
                showModal("Please select at least one product.");
                return;
            }
            if (bedrooms <= 0) {
                showModal("Please enter a valid number of bedrooms.");
                return;
            }
            
            // 3. Get ruleset and calculate duration
            const currentSchedule = appointments[page.photographerId];
            const categoryId = photographerProfiles[page.photographerId].category;
            const ruleset = timingCategories[categoryId];

            // Get the new "Number of Floors" value from the correct page element
            const numFloors = parseInt(pageElement.querySelector('.num-floors-input').value) || 1;
            const duration = calculateDuration(bedrooms, selectedProducts, ruleset, numFloors);

            // 4. --- Core Calculation Engine ---
            
            let arrivalTimeMins, arrivalWindowEndMins, finishTimeMins, finishWindowEndMins, wmsTimeMins, buffer;
            let latestFinishTimeForNextJob = 0; // in minutes-from-midnight
            
            if (currentSchedule.length === 0) {
                // This is the FIRST job of the day
                const arrivalTimeStr = document.getElementById('first-job-arrival-time').value;
                arrivalTimeMins = timeStringToMinutes(arrivalTimeStr); // e.g., "09:00" -> 540
                
                buffer = 0;
                
                // Set 30-min window
                arrivalWindowEndMins = arrivalTimeMins + ARRIVAL_WINDOW_BUFFER; // 540 + 30 = 570
                finishTimeMins = arrivalTimeMins + duration;
                finishWindowEndMins = arrivalWindowEndMins + duration;

                // --- WMS LOGIC (First Job) ---
                wmsTimeMins = arrivalTimeMins; // WMS time is the start, e.g., 540
                
                latestFinishTimeForNextJob = finishTimeMins;

            } else {
                // This is a SUBSEQUENT job
                latestFinishTimeForNextJob = currentSchedule[currentSchedule.length - 1].latestFinishMins;
                
                buffer = ruleset.travelBuffer;
                
                // 1. Calculate the "true" arrival time (e.g., 11:40 -> 700)
                const trueArrivalMins = latestFinishTimeForNextJob + travelTime + buffer;
                
                // 2. NEW STEP: Round the "true" arrival time to the nearest 15 mins (e.g., 700 -> 705)
                arrivalTimeMins = roundToNearest(trueArrivalMins, 15);
                
                // 3. Calculate all other times based on this *new rounded* arrivalTime
                arrivalWindowEndMins = arrivalTimeMins + ARRIVAL_WINDOW_BUFFER; // (e.g., 705 + 30 = 735)
                finishTimeMins = arrivalTimeMins + duration;
                finishWindowEndMins = arrivalWindowEndMins + duration;

                // --- WMS LOGIC (Subsequent Jobs) ---
                // 1. Find the midpoint of the *new rounded* arrival window (e.g., 705 + 15 = 720)
                const midArrivalMins = arrivalTimeMins + (ARRIVAL_WINDOW_BUFFER / 2);
                // 2. Round that midpoint to the nearest 30 mins (e.g., 720)
                wmsTimeMins = roundToNearest(midArrivalMins, 30);

                latestFinishTimeForNextJob = finishTimeMins;
            }

            // 5. Create appointment object
            const newAppointment = {
                // Store reference fields
                orderRef: orderRef,
                address: address,
                postcode: postcode,
                // Store calculation values
                travel: travelTime,
                buffer: buffer,
                arrivalStr: formatMinutes(arrivalTimeMins),
                arrivalWindowEndStr: formatMinutes(arrivalWindowEndMins),
                bedrooms: bedrooms,
                productsStr: selectedProducts.map(p => p.name).join(', '),
                duration: duration,
                finishTimeStr: formatMinutes(finishTimeMins),
                finishWindowEndStr: formatMinutes(finishWindowEndMins),
                wmsTimeStr: formatMinutes(wmsTimeMins),
                // Store the raw minutes for the *next* calculation
                latestFinishMins: latestFinishTimeForNextJob
            };

            currentSchedule.push(newAppointment);
            renderSchedule();
            resetFormFields(pageElement);
        }

        /**
         * NEW: Handles the "Calculate" button click on the Duration Calculator page
         */
        function handleCalculateDuration(e) {
            e.preventDefault();
            
            const pageElement = document.getElementById('page-calculator');
            const resultsWrapper = pageElement.querySelector('#duration-results-wrapper');
            const placeholder = pageElement.querySelector('#duration-placeholder');

            // 1. Get all form inputs
            const contextCatId = pageElement.querySelector('#context-select').value;
            const bedrooms = parseInt(pageElement.querySelector('#calc-bedrooms').value) || 0;
            const numFloors = parseInt(pageElement.querySelector('#calc-num-floors').value) || 1;
            
            const selectedProducts = [];
            pageElement.querySelectorAll('input[name="calc-product"]:checked').forEach(checkbox => {
                selectedProducts.push({
                    id: checkbox.value,
                    name: checkbox.nextElementSibling.textContent
                });
            });

            // 2. Validation
            if (!contextCatId) {
                showModal("Please select a context (Category or Photographer) first.");
                return;
            }
            if (bedrooms <= 0) {
                showModal("Please enter a valid number of bedrooms.");
                return;
            }
            if (selectedProducts.length === 0) {
                showModal("Please select at least one product.");
                return;
            }

            // 3. Get the ruleset for the *selected* context
            const selectedRuleset = timingCategories[contextCatId];
            const selectedContextName = selectedRuleset.name;

            // 4. Run the main calculation for the selected context
            const totalTime = calculateDuration(bedrooms, selectedProducts, selectedRuleset, numFloors);
            
            // 5. Populate the main display
            pageElement.querySelector('#total-time-display').textContent = formatDuration(totalTime);
            pageElement.querySelector('#total-time-minutes').textContent = `(${totalTime} minutes)`;
            pageElement.querySelector('#selected-context-name').textContent = selectedContextName;
            
            // 6. Run the Category Comparison calculations
            const cat1Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat1'], numFloors);
            const cat2Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat2'], numFloors);
            const cat3Time = calculateDuration(bedrooms, selectedProducts, timingCategories['cat3'], numFloors);

            const comparisonWrapper = pageElement.querySelector('#category-comparison-display');
            comparisonWrapper.innerHTML = `
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat1' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat1' ? 'text-custom-green' : 'text-gray-700'}">Cat 1 (New Staff):</span>
                    <span class="font-bold ${contextCatId === 'cat1' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat1Time)}</span>
                </div>
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat2' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat2' ? 'text-custom-green' : 'text-gray-700'}">Cat 2 (Mid-Range):</span>
                    <span class="font-bold ${contextCatId === 'cat2' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat2Time)}</span>
                </div>
                <div class="flex justify-between p-3 rounded-md ${contextCatId === 'cat3' ? 'bg-green-100 border border-custom-green' : 'bg-gray-50'}">
                    <span class="font-medium ${contextCatId === 'cat3' ? 'text-custom-green' : 'text-gray-700'}">Cat 3 (Experienced):</span>
                    <span class="font-bold ${contextCatId === 'cat3' ? 'text-custom-green' : 'text-gray-900'}">${formatDuration(cat3Time)}</span>
                </div>
            `;

            // 7. Get and Populate the Calculation Breakdown
            pageElement.querySelector('#breakdown-context-name').textContent = selectedContextName;
            const breakdownWrapper = pageElement.querySelector('#calculation-breakdown-display');
            const breakdownItems = getDurationBreakdown(bedrooms, selectedProducts, selectedRuleset, numFloors);
            breakdownWrapper.innerHTML = breakdownItems.map(item => `
                <div class="flex justify-between">
                    <span class="text-gray-600">${item.name}:</span>
                    <span class="font-medium text-gray-900">+${item.time} mins</span>
                </div>
            `).join('');

            // 8. Show the results
            placeholder.classList.add('hidden');
            resultsWrapper.classList.remove('hidden');
        }

        /**
         * NEW: Helper function to get the line-by-line breakdown for the calculator
         */
        function getDurationBreakdown(bedrooms, products, ruleset, numFloors) {
            let breakdown = [];
            const floorSurcharge = ruleset.floorSurcharge || 5;

            products.forEach(product => {
                const productId = product.id;
                
                if (ruleset.products.hasOwnProperty(productId)) {
                    const rules = ruleset.products[productId];
                    const rule = rules.sort((a, b) => a.maxBeds - b.maxBeds)
                                    .find(r => bedrooms <= r.maxBeds);
                    
                    if (rule) {
                        breakdown.push({ name: product.name, time: rule.time });
                    }

                    // Add 3D Showcase surcharge to breakdown
                    if (productId === 'showcase_3d') {
                        if (numFloors > 1) {
                            const surcharge = (numFloors - 1) * floorSurcharge;
                            if (surcharge > 0) {
                                breakdown.push({ name: `Floor Surcharge (${numFloors-1} extra)`, time: surcharge });
                            }
                        }
                    }
                }
            });

            if (breakdown.length === 0) {
                breakdown.push({ name: 'No products selected', time: 0 });
            }

            return breakdown;
        }
        
        /**
         * Resets the entire schedule for the *current* photographer
         */
        function resetSchedule() {
            const page = diaryPages.find(p => p.id === currentPageId);
            if (!page || !page.photographerId) return;
            
            appointments[page.photographerId] = [];
            renderSchedule();
            const pageElement = document.getElementById(currentPageId);
            resetFormFields(pageElement, true); // Force reset day start time
        }
        
        /**
         * Resets form fields, manages input enable/disable based on schedule
         */
        function resetFormFields(pageElement, forceResetDayStart = false) {
            const travelInput = pageElement.querySelector('#travel-time');
            const arrivalInput = pageElement.querySelector('#first-job-arrival-time');
            
            pageElement.querySelector('#bedrooms').value = '';
            pageElement.querySelectorAll('input[name="product"]:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            // Clear reference fields
            pageElement.querySelector('#ref-order-id').value = '';
            pageElement.querySelector('#ref-address').value = '';
            pageElement.querySelector('#ref-postcode').value = '';


            const page = diaryPages.find(p => p.id === currentPageId);
            const currentSchedule = page && page.photographerId ? appointments[page.photographerId] : [];

            if (forceResetDayStart || !currentSchedule || currentSchedule.length === 0) {
                // This is for the FIRST job
                arrivalInput.disabled = false;
                arrivalInput.value = "09:00";
                
                travelInput.disabled = true; // Disable travel
                travelInput.value = ''; // Clear and show placeholder
                travelInput.placeholder = 'N/A for first job';
                
            } else {
                // This is for SUBSEQUENT jobs
                arrivalInput.disabled = true; // Lock the arrival time
                
                travelInput.disabled = false; // Enable travel
                travelInput.value = '';
                travelInput.placeholder = 'e.g., 30'; // Show normal placeholder
            }
        }

        /**
         * Calculate the total on-site duration based on bedrooms and products
         */
        function calculateDuration(bedrooms, products, ruleset, numFloors) {
            let totalDuration = 0;
            const floorSurcharge = ruleset.floorSurcharge || 5; // Default to 5 mins if not specified

            products.forEach(product => {
                const productId = product.id;
                
                // Check if this product has rules defined in the category
                if (ruleset.products.hasOwnProperty(productId)) {
                    const rules = ruleset.products[productId];
                    
                    // Find the matching rule for the bedroom size
                    // We sort the rules by maxBeds to ensure we get the right one
                    const rule = rules.sort((a, b) => a.maxBeds - b.maxBeds)
                                    .find(r => bedrooms <= r.maxBeds);
                    
                    if (rule) {
                        totalDuration += rule.time;
                    }

                    // --- NEW 3D SHOWCASE LOGIC ---
                    // If this is the 3D Showcase, check for the floor surcharge
                    if (productId === 'showcase_3d') {
                        if (numFloors > 1) {
                            // Add surcharge for each floor *after* the first
                            const surcharge = (numFloors - 1) * floorSurcharge; 
                            totalDuration += surcharge;
                        }
                    }
                }
            });

            return totalDuration;
        }

        /**
         * Re-draw the schedule table for the *current* photographer
         */
        function renderSchedule() {
            const pageElement = document.getElementById(currentPageId);
            if (!pageElement) return;
            const tbody = pageElement.querySelector('#schedule-body');
            tbody.innerHTML = ''; // Clear table

            const page = diaryPages.find(p => p.id === currentPageId);
            if (!page || !page.photographerId) return;
            
            const currentSchedule = appointments[page.photographerId];
            
            currentSchedule.forEach((appt, index) => {
                // Create display strings for windows
                const arrivalDisplay = `${appt.arrivalStr} / ${appt.arrivalWindowEndStr}`;
                const finishDisplay = `${appt.finishTimeStr} / ${appt.finishWindowEndStr}`;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${index + 1}</td>
                        <!-- New Reference Columns -->
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 100px;" title="${appt.orderRef}">${appt.orderRef}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 150px;" title="${appt.address}">${appt.address}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 80px;" title="${appt.postcode}">${appt.postcode}</td>
                        <!-- Core Columns -->
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.travel}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.buffer}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-custom-green">${arrivalDisplay}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-red-600">${appt.wmsTimeStr}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${appt.bedrooms}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 150px;" title="${appt.productsStr}">${appt.productsStr}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatDuration(appt.duration)}</td>
                        <!-- FIX: Changed text-green-600 to text-custom-finish -->
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-custom-finish">${finishDisplay}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- UTILITY FUNCTIONS (Time-as-Minutes) ---

        /**
         * Converts "HH:MM" string to minutes-from-midnight
         * e.g., "09:00" -> 540
         */
        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        /**
         * Converts minutes-from-midnight to "HH:MM" string
         * e.g., 540 -> "09:00"
         */
        function formatMinutes(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * Helper to format duration in minutes to h:mm string
         * e.g., 75 -> "1:15"
         */
        function formatDuration(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * Rounds a number of minutes to the nearest interval
         * e.g., roundToNearest(700, 15) -> 705
         * e.g., roundToNearest(722, 30) -> 720
         */
        function roundToNearest(minutes, interval) {
            return Math.round(minutes / interval) * interval;
        }
        
        /**
         * Shows a custom modal dialog instead of alert()
         */
        function showModal(message, onConfirm) {
            let modal = document.getElementById('alert-modal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'alert-modal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';

            const modalContent = document.createElement('div');
            modalContent.className = 'relative mx-auto p-6 border w-96 shadow-lg rounded-md bg-white';

            const text = document.createElement('p');
            text.className = 'text-gray-700 text-sm';
            text.textContent = message;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'text-right mt-4';

            if (onConfirm) {
                const confirmButton = document.createElement('button');
                confirmButton.className = 'px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green';
                confirmButton.textContent = 'Yes';
                confirmButton.onclick = function() {
                    onConfirm();
                    modal.remove();
                };
                buttonContainer.appendChild(confirmButton);

                const cancelButton = document.createElement('button');
                cancelButton.className = 'ml-2 px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400';
                cancelButton.textContent = 'No';
                cancelButton.onclick = function() {
                    modal.remove();
                };
                buttonContainer.appendChild(cancelButton);
                confirmButton.focus();
            } else {
                const closeButton = document.createElement('button');
                closeButton.className = 'px-4 py-2 bg-custom-green text-white text-sm font-medium rounded-md shadow-sm hover:bg-custom-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green';
                closeButton.textContent = 'OK';
                closeButton.onclick = function() {
                    modal.remove();
                };
                buttonContainer.appendChild(closeButton);
                closeButton.focus();
            }

            modalContent.appendChild(text);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // --- START THE APP ---
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

